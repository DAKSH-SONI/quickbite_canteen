<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBite - Dynamic Canteen Order System</title>
    <!-- Tailwind CSS is loaded correctly here -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&display=swap" rel="stylesheet">
    <!-- Icons from Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-color: #FFFAF0; /* Creamy White/Highlight */
            --dark-bg: #111827; /* Dark Slate Blue/Black background */
            --card-bg: #1f2937; /* Slightly lighter card background */
            --login-card-bg: #2a2b38; /* Your login card background */
            --login-input-bg: #1f2029; /* Your login input background */
            --text-color: #f3f4f6;
            --accent-glow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color);
        }

        body {
            font-family: 'Times New Roman', serif;
            background-color: var(--dark-bg);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* --- Loading System (Wave) --- */
        .loading {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        .loading svg polyline {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .loading svg polyline#back {
            fill: none;
            stroke: var(--card-bg); /* Match background for subtle effect */
        }
        .loading svg polyline#front {
            fill: none;
            stroke: var(--primary-color);
            stroke-dasharray: 48, 144;
            stroke-dashoffset: 192;
            animation: dash_682 1.4s linear infinite;
        }
        @keyframes dash_682 {
            72.5% { opacity: 0; }
            to { stroke-dashoffset: 0; }
        }

        /* Base Card Styling (Used in all non-login views) */
        .canteen-card {
            background-color: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .canteen-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        }

        /* Standard Highlight Button Styling (Creamy White) */
        .glow-button {
            background: var(--primary-color);
            color: var(--dark-bg);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glow-button:hover {
            background: #fff;
            box-shadow: var(--accent-glow);
        }

        .glow-button:active {
            transform: scale(0.98);
        }

        /* --- USER PROVIDED LOGIN CARD STYLES --- */
        .login-card {
            width: 100%;
            max-width: 320px;
            padding: 1.9rem 1.2rem;
            text-align: center;
            background: var(--login-card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }
        .login-title {
            margin-bottom: 1rem;
            font-size: 1.8em;
            font-weight: bold;
            color: #f5f5f5;
        }

        .login-field {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5em;
            background-color: var(--login-input-bg);
            border-radius: 6px;
            padding: .75em 1em;
            border: 1px solid transparent;
            transition: border-color 0.3s;
        }
        .login-field:focus-within {
             border-color: var(--primary-color);
        }
        .input-icon {
            height: 1em;
            width: 1em;
            fill: var(--primary-color);
        }
        .input-field {
            background: none;
            border: none;
            outline: none;
            width: 100%;
            color: var(--text-color);
            padding: 0;
        }
        
        .login-btn {
            margin-top: 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: .9em;
            text-transform: uppercase;
            padding: 0.8em 1.2em;
            background-color: var(--primary-color);
            color: var(--login-card-bg);
            box-shadow: 0 8px 24px 0 rgba(255, 250, 240, 0.4);
            transition: all .3s ease-in-out;
            width: 100%;
        }

        .login-btn:hover {
            background-color: #fff;
            color: #5e6681;
            box-shadow: 0 8px 24px 0 rgba(255, 250, 240, 0.8);
        }
        
        /* --- DYNAMIC RADIO BUTTON STYLES (Adapted for 2 options) --- */
        .radio-container {
            --main-color: var(--primary-color);
            --main-color-opacity: #fffae81c;
            --total-radio: 2; 
            display: flex;
            flex-direction: column;
            position: relative;
            padding-left: 0.5rem;
            background-color: var(--login-input-bg);
            border-radius: 6px;
        }
        .radio-container input {
            cursor: pointer;
            appearance: none;
        }
        .radio-container .glider-container {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(27, 27, 27, 1) 50%, rgba(0, 0, 0, 0) 100%);
            width: 1px;
            border-radius: 6px;
        }
        .radio-container .glider-container .glider {
            position: relative;
            height: calc(100% / var(--total-radio));
            width: 100%;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, var(--main-color) 50%, rgba(0, 0, 0, 0) 100%);
            transition: transform 0.5s cubic-bezier(0.37, 1.95, 0.66, 0.56);
        }
        .radio-container .glider-container .glider::before {
            content: "";
            position: absolute;
            height: 60%;
            width: 300%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--main-color);
            filter: blur(10px);
        }
        .radio-container .glider-container .glider::after {
            content: "";
            position: absolute;
            left: 0;
            height: 100%;
            width: 150px;
            background: linear-gradient(90deg, var(--main-color-opacity) 0%, rgba(0, 0, 0, 0) 100%);
        }
        .radio-container label {
            cursor: pointer;
            padding: 0.75rem 1rem;
            position: relative;
            color: #9ca3af;
            transition: all 0.3s ease-in-out;
            text-align: left;
        }
        .radio-container input:checked + label {
            color: var(--main-color);
            font-weight: bold;
        }
        .radio-container input:nth-of-type(1):checked ~ .glider-container .glider {
            transform: translateY(0);
        }
        .radio-container input:nth-of-type(2):checked ~ .glider-container .glider {
            transform: translateY(100%);
        }
        /* --- END DYNAMIC RADIO BUTTON STYLES --- */

        /* --- LEADERBOARD GLOW BUTTON STYLES (Rainbow) --- */
        .leaderboard-btn-glow {
            position: relative;
            text-decoration: none;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            line-height: 55px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            height: 60px;
            margin-bottom: 2rem;
            display: block;
            -webkit-box-reflect: bottom 1px linear-gradient(transparent, #0004);
        }
        .leaderboard-btn-glow span {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            top: 4px;
            right: 4px;
            bottom: 4px;
            left: 4px;
            text-align: center;
            background: var(--card-bg);
            color: rgba(255, 255, 255, 0.9);
            transition: 0.5s;
            z-index: 1;
            padding: 0 10px;
        }
        .leaderboard-btn-glow:hover span {
            color: var(--primary-color);
        }
        .leaderboard-btn-glow::before,
        .leaderboard-btn-glow::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-size: 400%;
            opacity: 0;
            transition: 0.5s;
            background: linear-gradient(45deg, #fb0094, #525296, #ff8800, #00f, #fb0094);
            animation: animate123 10s linear infinite;
        }
        .leaderboard-btn-glow::after {
            filter: blur(20px);
        }
        .leaderboard-btn-glow:hover::before,
        .leaderboard-btn-glow:hover::after {
            opacity: 1;
        }
        @keyframes animate123 {
            0% { background-position: 0 0; }
            50% { background-position: 300% 0; }
            100% { background-position: 0 0; }
        }
        /* --- END LEADERBOARD GLOW BUTTON STYLES --- */
        
        /* --- FOLDING CORNER TOKEN STYLES (Adapted) --- */
        .token-button-wrapper {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        .token-button {
            --round: 0.75rem;
            cursor: pointer;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: all 0.25s ease;
            background: radial-gradient(65.28% 65.28% at 50% 100%, rgba(255, 250, 240, 0.1) 0%, rgba(255, 250, 240, 0) 100%), linear-gradient(0deg, #1f2937, #111827);
            border-radius: var(--round);
            border: none;
            outline: none;
            padding: 12px 18px;
            width: 100%;
            /* ADJUSTMENTS FOR LARGER FRAME */
            max-width: 350px; 
            height: 150px; /* Further Increased height for better vertical length */
            /* END ADJUSTMENTS */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .token-button::before,
        .token-button::after {
            content: "";
            position: absolute;
            inset: var(--space);
            transition: all 0.5s ease-in-out;
            border-radius: calc(var(--round) - var(--space));
            z-index: 0;
        }
        .token-button::before {
            --space: 1px;
            background: linear-gradient(177.95deg, rgba(255, 255, 255, 0.19) 0%, rgba(255, 255, 255, 0) 100%);
        }
        .token-button::after {
            --space: 2px;
            background: radial-gradient(65.28% 65.28% at 50% 100%, rgba(255, 250, 240, 0.1) 0%, rgba(255, 250, 240, 0) 100%), linear-gradient(0deg, #1f2937, #111827);
        }
        .token-button:active {
            transform: scale(0.98);
        }

        .token-fold {
            z-index: 1;
            position: absolute;
            top: 0;
            right: 0;
            /* ADJUSTMENTS FOR LARGER FOLD */
            height: 2rem; 
            width: 2rem;
            /* END ADJUSTMENTS */
            display: inline-block;
            transition: all 0.5s ease-in-out;
            background: radial-gradient(100% 75% at 55%, var(--primary-color) 0%, rgba(255, 250, 240, 0) 100%);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            border-bottom-left-radius: 0.5rem;
            border-top-right-radius: var(--round);
        }
        .token-fold::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 150%;
            height: 150%;
            transform: rotate(45deg) translateX(0%) translateY(-32px);
            background-color: var(--dark-bg);
            pointer-events: none;
        }
        .token-button:hover .token-fold {
            /* ADJUSTMENTS FOR LARGER FOLD HOVER */
            margin-top: -2rem; 
            margin-right: -2rem; 
            /* END ADJUSTMENTS */
        }

        .token-points-wrapper {
            overflow: hidden;
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            z-index: 1;
        }
        .token-points-wrapper .point {
            bottom: -10px;
            position: absolute;
            animation: floating-points-anim infinite ease-in-out;
            pointer-events: none;
            width: 2px;
            height: 2px;
            background-color: var(--primary-color);
            border-radius: 9999px;
            box-shadow: 0 0 3px var(--primary-color);
        }
        @keyframes floating-points-anim {
            0% { transform: translateY(0); }
            85% { opacity: 0; }
            100% { transform: translateY(-100px); opacity: 0; } /* Adjusted travel distance for taller bar */
        }
        /* Specific animations for points are defined in JS below for visibility */

        .token-inner {
            z-index: 2;
            gap: 6px;
            position: relative;
            width: 100%;
            color: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            line-height: 1.5;
            transition: color 0.2s ease-in-out;
            text-shadow: 0 0 5px rgba(255, 250, 240, 0.5);
            /* Centering the text vertically within the larger frame */
            margin-top: -10px; 
        }
        .token-inner .token-id {
            /* ADJUSTMENT for larger text inside the token */
            font-size: 4rem; /* Increased size to fill the taller bar */
            /* END ADJUSTMENT */
            font-weight: bold;
        }
        /* --- END FOLDING CORNER TOKEN STYLES --- */


        /* --- Other styles --- */
        .token-display {
            background: linear-gradient(135deg, #252b35, #1f2937);
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        
        /* New: Token Frame Glow Toggle */
        @keyframes subtleGlow {
            0% { box-shadow: 0 0 10px rgba(255, 250, 240, 0.2); }
            50% { box-shadow: 0 0 20px rgba(255, 250, 240, 0.5); }
            100% { box-shadow: 0 0 10px rgba(255, 250, 240, 0.2); }
        }

        #tokenFrame.active-glow {
            animation: subtleGlow 1.5s infinite alternate;
        }
        /* End New Style */


        .leader-item {
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .leader-item:nth-child(1) { background-color: #d9770644; border-left: 4px solid #fcd34d; }
        .leader-item:nth-child(2) { background-color: #9ca3af44; border-left: 4px solid #d1d5db; }
        .leader-item:nth-child(3) { background-color: #b4530944; border-left: 4px solid #fb923c; }
        .leader-item:hover { background-color: #4b5563; }

        .icon-container {
            transition: all 0.3s ease;
        }
        .icon-container:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .quantity-btn {
            background-color: var(--primary-color);
            color: var(--dark-bg);
            border-radius: 9999px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .quantity-btn:hover {
            background-color: #fff;
            transform: scale(1.05);
        }
        .quantity-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Profile Image Styles */
        .profile-pic {
            width: 4rem;
            height: 4rem;
            border-radius: 9999px;
            background-color: #3b82f6; /* Blue for student/default */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }
        .profile-pic.faculty {
            background-color: #f59e0b; /* Amber for faculty/priority */
        }
        .profile-pic.owner {
            background-color: #10b981; /* Emerald for owner */
        }
        
        /* New Login/Register Button Group */
        .toggle-btn-group {
            display: flex;
            background: var(--login-input-bg);
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 1.5rem;
        }
        .toggle-btn {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 4px;
            font-weight: bold;
            color: #9ca3af;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .toggle-btn.active {
            background: var(--dark-bg);
            color: var(--primary-color);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
        }

        /* ðŸŒŸ Lamp Animation Overlay */
        #loginAnimationOverlay {
          position: fixed;
          inset: 0;
          background: rgba(10, 10, 20, 0.92);
          z-index: 99999;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          overflow: hidden;
        }
        .overlay-bg {
          position: absolute;
          inset: 0;
          background: radial-gradient(circle at center, rgba(255,255,255,0.06), rgba(0,0,0,0.95));
          z-index: 1;
        }
        .lamp-container {
          z-index: 2;
          text-align: center;
          animation: fadeIn 0.6s ease forwards;
        }
        .lamp {
          position: relative;
          width: 120px;
          height: 200px;
          margin: 0 auto;
          animation: swing 2s ease-in-out infinite;
        }
        .cable {
          position: absolute;
          top: 0;
          left: 50%;
          width: 4px;
          height: 80px;
          background: #222;
          transform: translateX(-50%);
        }
        .cover {
          position: absolute;
          top: 70px;
          left: 50%;
          width: 70px;
          height: 40px;
          background: #111;
          border-radius: 50% 50% 10px 10px;
          transform: translateX(-50%);
        }
        .light {
          position: absolute;
          top: 110px;
          left: 50%;
          width: 100px;
          height: 100px;
          background: radial-gradient(circle at center, rgba(255,215,100,0.8), rgba(255,200,0,0));
          transform: translateX(-50%);
          border-radius: 50%;
          opacity: 0;
          animation: lightGlow 2s ease-in-out infinite;
        }
        .token-box {
          z-index: 3;
          background: #fff8dc;
          color: #111;
          font-weight: bold;
          font-size: 1.4rem;
          border-radius: 12px;
          padding: 10px 25px;
          margin-top: 20px;
          display: inline-block;
          box-shadow: 0 0 15px rgba(255,255,200,0.8);
          opacity: 0;
          transform: scale(0.8);
          animation: popUp 1s ease forwards 2s;
        }
        .animation-text {
          color: #f1f1f1;
          font-size: 0.9rem;
          margin-top: 12px;
          opacity: 0;
          animation: fadeIn 0.8s ease forwards 2.5s;
        }
        /* Animations */
        @keyframes swing {
          0% { transform: rotate(-3deg); }
          50% { transform: rotate(3deg); }
          100% { transform: rotate(-3deg); }
        }
        @keyframes lightGlow {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 1; }
        }
        @keyframes fadeIn {
          to { opacity: 1; }
        }
        @keyframes popUp {
          to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
          to { opacity: 0; visibility: hidden; }
        }
    </style>
</head>
<body>
<!-- ðŸ”† Login/Register Lamp Animation Overlay -->
<div id="loginAnimationOverlay" style="display:none;">
  <div class="overlay-bg"></div>
  <div class="lamp-container">
    <div class="lamp">
      <div class="cable"></div>
      <div class="cover"></div>
      <div class="light"></div>
    </div>
    <div class="token-box">
      <span id="animatedToken">--</span>
    </div>
    <p class="animation-text">Generating your token...</p>
  </div>
</div>

<!-- Token display frame (animated) -->
<style>
#tokenFrame {
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 220px;
  background: linear-gradient(135deg,#fff,#f7f7f9);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  padding: 14px;
  font-family: sans-serif;
  z-index: 2000;
  text-align:center;
}
</style>

<div id="tokenFrame" aria-live="polite" style="display:none;">
  <h4>Your Order Token</h4>
  <div id="tokenNumber" aria-hidden="true">---</div>
  <div id="tokenLight" title="status light"></div>
  <div>
    <button id="tokenBtn">Show Token</button>
  </div>
</div>


<!-- Owner dashboard panel -->
<style>
#ownerPanel { position: fixed; left: 18px; bottom: 18px; width: 360px; max-height:60vh; overflow:auto; background:#fff;border-radius:10px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:2000; font-family:sans-serif;}
#ownerPanel h4 { margin:6px 0; }
#ownerPanel table { width:100%; border-collapse: collapse; font-size:13px; }
#ownerPanel td, #ownerPanel th { padding:6px; border-bottom:1px solid #eee; text-align:left; }
#ownerPanel button { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
</style>
<div id="ownerPanel" aria-hidden="true" style="display:none;">
  <h4>Owner Dashboard</h4>
  <div><strong>Stock Management</strong></div>
  <table id="ownerStockTable"><thead><tr><th>Item</th><th>Stock</th><th>Update</th></tr></thead><tbody></tbody></table>
  <div style="margin-top:8px"><strong>Udhar / Payments</strong></div>
  <table id="udharTable"><thead><tr><th>Order</th><th>Amount</th><th>Action</th></tr></thead><tbody></tbody></table>
  <div style="margin-top:8px"><strong>Cancelled Orders</strong></div>
  <ul id="cancelList"></ul>
  <div style="margin-top:8px"><button onclick="refreshOwnerPanel()">Refresh</button></div>
</div>
<script>
function refreshOwnerPanel() {
  const panel = document.getElementById('ownerPanel');
  const userId = APP_STATE.currentUserId;
  if (!userId) { panel.style.display='none'; return; }
  const user = APP_STATE.users[userId];
  if (!user || !user.isOwner) { panel.style.display='none'; return; }
  panel.style.display='block';
  // populate stock table
  const tbody = document.querySelector('#ownerStockTable tbody');
  tbody.innerHTML = '';
  APP_STATE.menu.forEach(it => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td id="stock-${it.id}">${it.stock}</td><td><input id="stock-in-${it.id}" type="number" style="width:70px"/><button onclick="ownerSetStock('${it.id}')">Set</button> <button onclick="ownerAddStock('${it.id}')">+Add</button></td>`;
    tbody.appendChild(tr);
  });
  // udhar table
  const ut = document.querySelector('#udharTable tbody');
  ut.innerHTML = '';
  APP_STATE.orderQueue.filter(o=>o.paymentDue && o.paymentDue>0).forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.id} / ${o.token}</td><td>${o.paymentDue}</td><td><button onclick="settlePayment('${o.id}')">Settle</button></td>`;
    ut.appendChild(tr);
  });
  // cancel list
  const cl = document.getElementById('cancelList');
  cl.innerHTML = '';
  APP_STATE.orderQueue.filter(o=>o.status==='Cancelled').forEach(o=>{
    const li = document.createElement('li');
    li.textContent = o.id + ' - ' + (o.token || '') + ' by ' + (o.userName || 'unknown');
    cl.appendChild(li);
  });
}

function ownerSetStock(id) {
  const v = parseInt(document.getElementById('stock-in-' + id).value || '0',10);
  const it = APP_STATE.menu.find(m=>m.id===id);
  if (it) { it.stock = v; document.getElementById('stock-' + id).textContent = v; showMessage('Stock set for '+it.name,'success'); }
}
function ownerAddStock(id) {
  const v = parseInt(document.getElementById('stock-in-' + id).value || '0',10);
  const it = APP_STATE.menu.find(m=>m.id===id);
  if (it) { it.stock += v; document.getElementById('stock-' + id).textContent = it.stock; showMessage('Added stock for '+it.name,'success'); }
}
function settlePayment(orderId) {
  const ord = APP_STATE.orderQueue.find(o=>o.id===orderId);
  if (!ord) return;
  ord.paymentDue = 0;
  showMessage('Payment settled for '+orderId,'success');
  refreshOwnerPanel();
}
// Called by owner to mark order statuses in queue rendering
function ownerMarkReady(orderId) {
  const ord = APP_STATE.orderQueue.find(o=>o.id===orderId);
  if (!ord) return;
  ord.status = 'Ready';
  showMessage('Order ' + orderId + ' marked Ready','success');
  renderQueue(); refreshOwnerPanel();
}
function ownerMarkComplete(orderId) {
  const ord = APP_STATE.orderQueue.find(o=>o.id===orderId);
  if (!ord) return;
  ord.status = 'Complete';
  showMessage('Order ' + orderId + ' marked Complete','success');
  renderQueue(); refreshOwnerPanel();
}
function ownerCancelOrder(orderId) {
  const ord = APP_STATE.orderQueue.find(o=>o.id===orderId);
  if (!ord) return;
  ord.status = 'Cancelled';
  ord.userName = (APP_STATE.users[ord.token] && APP_STATE.users[ord.token].name) || ord.token;
  showMessage('Order ' + orderId + ' Cancelled','error');
  renderQueue(); refreshOwnerPanel();
}
</script>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading hidden">
        <svg height="48px" width="64px">
            <polyline id="back" points="0.157 23.954, 14 23.954, 21.843 48, 43 0, 50 24, 64 24"></polyline>
            <polyline id="front" points="0.157 23.954, 14 23.954, 21.843 48, 43 0, 50 24, 64 24"></polyline>
        </svg>
    </div>

    <div id="app" class="w-full max-w-5xl">
        <!-- Main Content Area -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold tracking-widest text-white mb-2" style="text-shadow: 0 0 10px var(--primary-color);">
                QUICKBITES
            </h1>
            <p class="text-gray-400 text-lg">Smart Canteen Order System</p>
        </header>

        <!-- Dynamic View Container -->
        <!-- Added extra padding to ensure content is visible above the fixed navbar -->
        <div id="view-container" class="transition-all duration-500 pb-20 md:pb-24"> 
            <!-- Content will be injected here -->
        </div>

        <!-- Navigation Bar (Hidden on login/owner views, controlled by setView logic) -->
        <nav id="navbar" class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-gray-700 shadow-2xl z-50 hidden">
            <div class="flex justify-around max-w-xl mx-auto">
                <button onclick="setView('order')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="utensils" class="w-6 h-6 mb-1"></i>
                    Order Now
                </button>
                <button onclick="setView('queue')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="clock-4" class="w-6 h-6 mb-1"></i>
                    My Queue
                </button>
                <button onclick="setView('leaderboard')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="trophy" class="w-6 h-6 mb-1"></i>
                    Leaderboard
                </button>
                <button onclick="setView('account')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="settings" class="w-6 h-6 mb-1"></i>
                    Account
                </button>
                <button onclick="logout()" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-red-400 hover:text-red-300 transition-colors">
                    <i data-lucide="log-out" class="w-6 h-6 mb-1"></i>
                    Logout
                </button>
            </div>
        </nav>
    </div>

    <script>
        // --- Helper functions ---
        
        // Helper: return image URL for a menu item, or fallback placeholder
        function getImageFor(item) {
            // This function is still present for backwards compatibility if needed, but the menu items now have direct image URLs.
            // if (getImageFor(item)) return getImageFor(item); <-- Removed recursive call which would lead to stack overflow
            return 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';
        }

        // Token generators
        function generateStudentTokenFromRoll(roll) {
            if (!roll) return 'S-000';
            // try to parse: digits + letters + digits, take last two letters from letters part as dept, and last two digits from trailing numbers
            const m = roll.match(/(\d{2})([A-Z]+)(\d+)/i);
            if (m) {
                const letters = m[2].toUpperCase();
                const trailing = m[3];
                const dept = letters.slice(-2);
                const lastN = trailing.slice(-2);
                return dept + '-' + lastN;
            }
            // fallback: S- + last 3 digits
            const last = roll.replace(/\D/g,'').slice(-2);
            return 'S-' + (last || '00');
        }

        function generateOwnerTokenByIndex(idx) {
            // idx is 1-based index; map to letter A..Z cyclically and three-digit number equal to idx padded
            const letterIndex = (idx - 1) % 26;
            const letter = String.fromCharCode(65 + letterIndex);
            const num = String(idx).padStart(3,'0');
            return letter + '-' + num;
        }

        // --- DATA / STATE MANAGEMENT (Simulated) ---

        const APP_STATE = {
            users: {
                // Default registered users for testing
                'F101': { id: 'F101', name: 'Dr. Jane Smith', password: '123', role: 'Faculty', token: 'F-101', udhar: 450, ordersPlaced: 55, isPriority: true, isLoggedIn: true },
                'S503': { id: 'S503', name: 'Aarav Sharma', password: '123', role: 'Student', token: 'S-503', udhar: 120, ordersPlaced: 92, isPriority: false, isLoggedIn: true },
                // Owner User
                'O100': { id: 'O100', name: 'Canteen Owner', password: '123', role: 'Owner', token: 'O-100', udhar: 0, ordersPlaced: 0, isPriority: false, isOwner: true, isLoggedIn: true }
            },
            userProfiles: {}, 
            currentUserId: null, 

            menu: [
                // Fast Prep Items (30 seconds = 0.5 min)
                { id: 'samosa', name: 'Samosa', price: 20, stock: 25, prepTime: 0.5, category: 'cooked', image: 'https://placehold.co/100x100/34D399/1F2937?text=Samosa' },
                { id: 'daalkachori', name: 'Daal Kachori', price: 25, stock: 15, prepTime: 0.5, category: 'cooked', image: 'https://placehold.co/100x100/FBBF24/1F2937?text=Daal+Kachori' },
                { id: 'mirchivada', name: 'Mirchivada', price: 30, stock: 10, prepTime: 0.5, category: 'cooked', image: 'https://placehold.co/100x100/F87171/1F2937?text=Mirchi+Vada' },
                { id: 'pyazkachori', name: 'Pyaz Kachori', price: 25, stock: 12, prepTime: 0.5, category: 'cooked', image: 'https://placehold.co/100x100/93C5FD/1F2937?text=Pyaz+Kachori' },
                
                // Slow Prep Items (10 minutes)
                { id: 'maggi', name: 'Maggi', price: 50, stock: 8, prepTime: 10, category: 'cooked', image: 'https://placehold.co/100x100/60A5FA/1F2937?text=Maggi' },

                // Standard Prep Items (2 minutes)
                { id: 'tea', name: 'Masala Tea', price: 15, stock: 99, prepTime: 2, category: 'drink', image: 'https://placehold.co/100x100/FCA5A5/1F2937?text=Masala+Tea' },
                { id: 'sandwich', name: 'Grilled Sandwich', price: 75, stock: 0, prepTime: 2, category: 'cooked', image: 'https://placehold.co/100x100/A78BFA/1F2937?text=Sandwich' },

                // Packaged/Instant Items (0 minutes)
                { id: 'lays', name: 'Lays Wafers', price: 20, stock: 50, prepTime: 0, category: 'packet', image: 'https://placehold.co/100x100/FFFAF0/1F2937?text=Lays' },
                { id: 'kurkure', name: 'Kurkure', price: 20, stock: 40, prepTime: 0, category: 'packet', image: 'https://placehold.co/100x100/06B6D4/1F2937?text=Kurkure' },
                { id: 'balaji', name: 'Balaji Sev', price: 25, stock: 30, prepTime: 0, category: 'packet', image: 'https://placehold.co/100x100/FCD34D/1F2937?text=Balaji+Sev' },
                { id: 'segar', name: 'Seegar Chips', price: 20, stock: 45, prepTime: 0, category: 'packet', image: 'https://placehold.co/100x100/C084FC/1F2937?text=Seegar+Chips' },
            ],

            orderQueue: [
                // Initial orders (must have scheduledPickupTimeMs)
                // Set initial times relative to now for realistic ETA behavior
                { id: 'Q1', token: 'S-503', items: [{ name: 'Masala Tea', quantity: 1, price: 15, prepTime: 2 }], status: 'In Prep', eta: new Date(Date.now() + 5 * 60 * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), total: 15, scheduledPickupTimeMs: Date.now() + 5 * 60 * 1000 },
                { id: 'Q2', token: 'F-101', items: [{ name: 'Samosa', quantity: 2, price: 20, prepTime: 0.5 }], status: 'Ready', eta: new Date(Date.now() + 10 * 60 * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), total: 40, scheduledPickupTimeMs: Date.now() + 10 * 60 * 1000 },
                { id: 'Q3', token: 'S-210', items: [{ name: 'Maggi', quantity: 1, price: 50, prepTime: 10 }], status: 'Queued', eta: new Date(Date.now() + 20 * 60 * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), total: 50, scheduledPickupTimeMs: Date.now() + 20 * 60 * 1000 },
            ],

            cancelledOrders: [
                // { id: 'C1', token: 'S-888', reason: 'Customer Cancelled', items: 'Coffee x 1', timestamp: '10:30 AM' }
            ],

            udharLedger: {
                'S-503': 120,
                'F-101': 450,
                'S-210': 30,
                'O-100': 0,
            },

            ownerNotifications: [
                // { id: 'N1', type: 'udhar_cleared', token: 'F-101', amount: 450, timestamp: new Date().toLocaleTimeString() }
            ]
        };

        let cart = [];
        let currentAuthMode = 'login'; // 'login' or 'register'

        // --- PROFILE PICTURE UTILITIES (Defined early to resolve ReferenceError) ---

        // Utility to get initials for profile pic
        function getInitials(name) {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function setProfilePicture() {
            // Trigger the hidden file input click (Input is rendered in renderAccount)
            document.getElementById('profile-upload').click();
        }

        function handleProfileImage(event) {
            const file = event.target.files[0];
            const userId = APP_STATE.currentUserId;
            if (file && userId) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Store the image data URL
                    APP_STATE.userProfiles[userId] = e.target.result;
                    showMessage("Profile picture updated!", 'success');
                    // Re-render the account view to show the new picture
                    setView('account');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function getProfileHtml(user) {
            const profileUrl = APP_STATE.userProfiles[user.id];
            const initials = getInitials(user.name);
            const userRoleClass = user.role === 'Faculty' ? 'faculty' : (user.role === 'Owner' ? 'owner' : '');
            
            // This entire component is clickable to trigger the file input
            const profileComponent = profileUrl 
                ? `<img src="${profileUrl}" alt="${user.name}" class="profile-pic ${userRoleClass} cursor-pointer">`
                : `<div class="profile-pic ${userRoleClass} cursor-pointer">${initials}</div>`;

            // We wrap it in a container that handles the click and holds the hidden input
            return `
                <div onclick="setProfilePicture()">
                    ${profileComponent}
                    <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="handleProfileImage(event)">
                </div>
            `;
        }

        // --- UTILITY & VIEW SWITCHING ---

        const VIEW_RENDERERS = {
            login: renderLogin,
            order: renderOrder,
            queue: renderQueue,
            leaderboard: renderLeaderboard,
            account: renderAccount,
            owner: renderOwnerDashboard
        };
        
        function showLoader() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function toggleNavbar(show) {
            const navbar = document.getElementById('navbar');
            if (navbar) {
                if (show) {
                    navbar.classList.remove('hidden');
                } else {
                    navbar.classList.add('hidden');
                }
            }
        }

        function setAuthMode(mode) {
            currentAuthMode = mode;
            setView('login');
        }

        
function logout() {
    APP_STATE.currentUserId = null;
    // hide token display
    const num = document.getElementById('tokenNumber');
    const frame = document.getElementById('tokenFrame');
    if (num) { num.textContent = '---'; num.classList.remove('show'); }
    if (frame) { frame.style.display = 'none'; frame.classList.remove('active-glow'); }
    showMessage('Logged out successfully.', 'success');
    setView('login');
}

function setView(viewName) {
            showLoader();
            
            let finalView = viewName;
            const user = APP_STATE.users[APP_STATE.currentUserId];
            // generate token based on role
            let tokenToUse = (user && user.token) || '';
            let userName = (user && user.name) || '';
            
            if (user && !user.isOwner) {
                // for students, try to get roll from input or user profile
                const roll = (document.getElementById('studentRoll') && document.getElementById('studentRoll').value.trim()) || (user.roll || '');
                tokenToUse = generateStudentTokenFromRoll(roll);
                // Update token in user object for persistence in this session
                user.token = tokenToUse;
            }
            

            // Handle unauthorized access or logout
            if (viewName !== 'login') {
                if (!user) {
                    finalView = 'login';
                    toggleNavbar(false);
                } else if (user.role === 'Owner') {
                    finalView = 'owner';
                    toggleNavbar(false);
                } else if (user.role !== 'Owner' && viewName === 'owner') {
                    finalView = 'order'; // Redirect regular users away from owner page
                    toggleNavbar(true);
                } else {
                    toggleNavbar(true); // Show navbar for regular user views
                }
            } else {
                toggleNavbar(false); // Hide navbar on login
            }
            
            // Allow a brief animation before rendering
            setTimeout(() => {
                const viewContainer = document.getElementById('view-container');
                const renderer = VIEW_RENDERERS[finalView];
                
                if (renderer) {
                    viewContainer.innerHTML = renderer();
                } else {
                    viewContainer.innerHTML = '<h2>404: View Not Found</h2>';
                }

                lucide.createIcons();
                hideLoader();

                // Re-run updateCartUI if we are on the order page to initialize cart visuals
                if (finalView === 'order') {
                    updateCartUI(); 
                }
                
                // Refresh owner panel if it's the owner view
                if (finalView === 'owner') {
                    refreshOwnerPanel();
                }
            }, 300); // 300ms delay for loading animation
        }

        // Custom Message Box (No Alerts!)
        function showMessage(message, type) {
            const existingMessage = document.getElementById('app-message');
            if (existingMessage) existingMessage.remove();

            const bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
            const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'x-circle' : 'info');

            const msgHtml = document.createElement('div');
            msgHtml.id = 'app-message';
            msgHtml.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-xl text-white z-[100] transition-all duration-300 flex items-center ${bgColor}`;
            msgHtml.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-3"></i> ${message}`;
            
            document.body.appendChild(msgHtml);
            lucide.createIcons();

            setTimeout(() => {
                msgHtml.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => msgHtml.remove(), 300);
            }, 5000);
        }

        // ðŸŒŸ Lamp Animation Function
        function showLoginAnimation(token, callback) {
          const overlay = document.getElementById("loginAnimationOverlay");
          const tokenSpan = document.getElementById("animatedToken");

          // Reset previous state and display overlay
          overlay.style.animation = "";
          overlay.style.opacity = 1;
          overlay.style.display = "flex";
          document.body.style.overflow = "hidden";
          tokenSpan.textContent = token || "--";

          // Hide after 4 seconds and show main content
          setTimeout(() => {
            overlay.style.animation = "fadeOut 1s forwards";
            setTimeout(() => {
              overlay.style.display = "none";
              document.body.style.overflow = "auto";
              if (callback) callback();
            }, 900);
          }, 4000);
        }
        
        // --- AUTHENTICATION / REGISTRATION ---

        function handleAuth() {
            const role = document.querySelector('input[name="userRole"]:checked')?.value;
            const password = document.getElementById('password').value.trim();

            if (currentAuthMode === 'register') {
                handleRegistration(role, password);
            } else {
                handleLogin(role, password);
            }
        }

        function handleRegistration(role, password) {
            let id, name, token, extraField;

            if (role === 'Student') {
                const rollInput = document.getElementById('rollNumber');
                id = rollInput.value.trim();
                name = document.getElementById('studentName').value.trim();
                extraField = document.getElementById('collegeName').value.trim(); // College Name
                token = generateStudentTokenFromRoll(id);
                if (!id || !name || !password || !extraField) {
                    return showMessage('Please fill all registration fields (Name, Roll Number, College, Password).', 'error');
                }
            } else { // Owner
                // Generate a new Owner ID automatically (O101, O102...) based on existing owners
                const ownerIds = Object.keys(APP_STATE.users).filter(k => k.startsWith('O')).map(k => parseInt(k.slice(1))).filter(n => !isNaN(n));
                const maxOwner = ownerIds.length ? Math.max(...ownerIds) : 100;
                const newOwnerNum = maxOwner + 1;
                id = 'O' + newOwnerNum; // e.g. O101
                name = document.getElementById('canteenName').value.trim();
                const college = (document.getElementById('collegeName')||{value:''}).value.trim();
                token = generateOwnerTokenByIndex(newOwnerNum);
                // save college to profile
                extraFields = { collegeName: college };
                if (!name || !password) {
                    return showMessage('Please fill all registration fields (Canteen Name, Password).', 'error');
                }
                // Informative note: owner id generated automatically
            }
            
            if (APP_STATE.users[id]) {
                return showMessage(`Error: Account with ID ${id} already exists. Please login.`, 'error');
            }

            const newUser = {
                id: id,
                name: name,
                college: role === 'Student' ? extraField : undefined,
                canteen: role === 'Owner' ? name : undefined,
                token: token,
                password: password,
                role: role,
                udhar: 0,
                ordersPlaced: 0,
                isPriority: role === 'Faculty', // Placeholder, but functional for future use
                isOwner: role === 'Owner',
                isLoggedIn: true
            };
            
            APP_STATE.users[id] = newUser;
            APP_STATE.udharLedger[token] = 0;
            APP_STATE.currentUserId = id;

            // Trigger animation before setting view
            showLoginAnimation(token, () => {
                showMessage(`Registration successful! Your token is ${token}.`, 'success');
                setView(role === 'Owner' ? 'owner' : 'order');
            });
        }

        function handleLogin(role, password) {
            let id, user;
            let tokenToUse;

            if (role === 'Student') {
                const idInput = document.getElementById('rollNumberLogin');
                const studentName = document.getElementById('studentNameLogin').value.trim();
                id = idInput.value.trim();
                
                if (!id || !studentName || !password) {
                    return showMessage('Please enter your Name, Roll Number, and Password.', 'error');
                }
                
                user = APP_STATE.users[id];

                if (!user || user.password !== password || user.role !== role || user.name !== studentName) {
                    return showMessage('Login failed: Invalid Name, Roll Number, or Password.', 'error');
                }
                tokenToUse = user.token;

            } else { // Owner
                id = document.getElementById('ownerId').value.trim();
                if (!id || !password) {
                    return showMessage('Please enter your Owner ID and Password.', 'error');
                }
                 user = APP_STATE.users[id];
                 if (!user || user.password !== password || user.role !== role) {
                    return showMessage('Login failed: Invalid ID/Roll Number or Password.', 'error');
                }
                tokenToUse = user.token;
            }
            
            APP_STATE.currentUserId = id;
            
            // Trigger animation before setting view
            showLoginAnimation(tokenToUse, () => {
                showMessage(`Welcome back, ${user.name}!`, 'success');
                setView(user.role === 'Owner' ? 'owner' : 'order');
            });
        }
        
        // --- ORDERING LOGIC ---
        
        function addToCart(itemId) {
            const item = APP_STATE.menu.find(i => i.id === itemId);
            if (item && item.stock > 0) {
                const cartItem = cart.find(c => c.id === itemId);
                if (cartItem) {
                    if (cartItem.quantity < item.stock) {
                        cartItem.quantity++;
                    } else {
                        showMessage(`Cannot add more: only ${item.stock} of ${item.name} remaining.`, 'error');
                        return;
                    }
                } else {
                    cart.push({ ...item, quantity: 1 });
                }
                updateCartUI();
                showMessage(`${item.name} added to cart!`, 'info');
            } else {
                showMessage(`Sorry, ${item.name} is out of stock.`, 'error');
            }
        }

        function removeFromCart(itemId) {
            const cartItemIndex = cart.findIndex(c => c.id === itemId);
            if (cartItemIndex !== -1) {
                const item = cart[cartItemIndex];
                item.quantity--;
                if (item.quantity <= 0) {
                    cart.splice(cartItemIndex, 1);
                }
            }
            updateCartUI();
        }
        
        function updateCartUI() {
            // Function runs only if the Order view elements exist
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalSpan = document.getElementById('cart-total');
            const placeOrderBtn = document.getElementById('place-order-btn');

            if (!cartItemsContainer || !cartTotalSpan || !placeOrderBtn) return;
            
            let total = 0;
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<div class="text-gray-500 py-4">Cart is empty. Add items above.</div>';
                cartTotalSpan.textContent = 'â‚¹0';
                placeOrderBtn.disabled = true;
                return;
            }

            const cartHtml = cart.map(item => {
                total += item.price * item.quantity;
                return `
                    <div class="flex justify-between items-center bg-gray-700/50 p-3 rounded-lg mb-2">
                        <span class="text-white">${item.name} x ${item.quantity}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-300">â‚¹${item.price * item.quantity}</span>
                            <button onclick="removeFromCart('${item.id}')" class="quantity-btn w-6 h-6 flex items-center justify-center">
                                <i data-lucide="minus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            cartItemsContainer.innerHTML = cartHtml;
            cartTotalSpan.textContent = `â‚¹${total}`;
            placeOrderBtn.disabled = false;
            lucide.createIcons();
        }
        
        

function placeOrder() {
            if (cart.length === 0) return;

            const user = APP_STATE.users[APP_STATE.currentUserId];
            // generate token based on role
            let tokenToUse = user.token || '';
            if (!user.isOwner) {
                // for students, try to get roll from input or user profile
                const roll = (document.getElementById('studentRoll') && document.getElementById('studentRoll').value.trim()) || (user.roll || '');
                tokenToUse = generateStudentTokenFromRoll(roll);
            }
            // attach token and userName
            const userName = user.name || '';

            const orderItemsDetail = cart.map(item => ({ 
                id: item.id,
                name: item.name, 
                quantity: item.quantity, 
                price: item.price,
                prepTime: item.prepTime // in minutes (decimal)
            }));

            // 1. Stock Decrease 
            cart.forEach(cartItem => {
                const menuItem = APP_STATE.menu.find(m => m.id === cartItem.id);
                if (menuItem) menuItem.stock -= cartItem.quantity;
            });

            // 2. Dynamic ETA calculation (kitchen model: only 'tea' and 'maggie' are cooked on-demand)
            const cookedIds = ['tea','maggi']; // only these need actual prepTime at order time
            const baseWaitTimeMinutes = user.isPriority ? 0.5 : 1.0; // buffer

            const activeOrders = APP_STATE.orderQueue.filter(o => o.status !== 'Complete' && o.status !== 'Cancelled');
            const latestOrderFinishTimeMs = activeOrders.reduce((latestTime, order) => {
                return Math.max(latestTime, order.scheduledPickupTimeMs || 0);
            }, Date.now());
            let startTimeMs = Math.max(Date.now(), latestOrderFinishTimeMs);
            startTimeMs += Math.round(baseWaitTimeMinutes * 60 * 1000);

            const itemReadyTimes = orderItemsDetail.map(it => {
                // Items that are not cooked are treated as already-made/stocked and available quickly.
                if (!cookedIds.includes(it.id)) {
                    const effectivePrepMs = 5 * 1000; // 5 seconds for packet/stocked items
                    return {
                        id: it.id,
                        name: it.name,
                        quantity: it.quantity,
                        prepMs: effectivePrepMs,
                        readyAtMs: startTimeMs + effectivePrepMs
                    };
                } else {
                    // cooked items: use prepTime per item. If quantity >1, assume items prepared sequentially per quantity.
                    const perItemPrepMs = Math.round(it.prepTime * 60 * 1000); // prepTime is minutes
                    const effectivePrepMs = perItemPrepMs * it.quantity;
                    return {
                        id: it.id,
                        name: it.name,
                        quantity: it.quantity,
                        prepMs: effectivePrepMs,
                        readyAtMs: startTimeMs + effectivePrepMs
                    };
                }
            });

            const scheduledPickupTimeMs = itemReadyTimes.reduce((m, it) => Math.max(m, it.readyAtMs), startTimeMs);
            const etaDate = new Date(scheduledPickupTimeMs);
            const etaString = etaDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const totalWaitMs = scheduledPickupTimeMs - Date.now();
            const totalWaitMinutes = Math.floor(totalWaitMs / (60 * 1000));
            const totalWaitSeconds = Math.ceil((totalWaitMs % (60 * 1000)) / 1000);
            const displayWaitTime = `${totalWaitMinutes} min ${totalWaitSeconds} sec`;

            const newOrderId = 'Q' + (APP_STATE.orderQueue.length + 1);
            const payLater = !!document.getElementById('payLater') && document.getElementById('payLater').checked;
            
            // Calculate total cost
            const orderTotal = cart.reduce((s, c) => s + (c.price * c.quantity), 0);
            
            APP_STATE.orderQueue.push({
                id: newOrderId,
                token: tokenToUse,
                items: orderItemsDetail.map(it => ({ name: it.name, quantity: it.quantity, price: it.price, prepTime: it.prepTime })),
                status: 'Queued',
                eta: etaString,
                total: orderTotal,
                paymentDue: payLater ? orderTotal : 0,
                scheduledPickupTimeMs: scheduledPickupTimeMs,
                itemReadyTimes: itemReadyTimes
            });

            user.ordersPlaced++; 
            // Save roll number if it was available (primarily for registration, but for token consistency)
            user.roll = (document.getElementById('rollNumber') && document.getElementById('rollNumber').value.trim()) || user.roll;
            
            // If paying later, update ledger (only for non-owner users)
            if (payLater && !user.isOwner) {
                APP_STATE.udharLedger[tokenToUse] = (APP_STATE.udharLedger[tokenToUse] || 0) + orderTotal;
            }
            
            cart = [];

            // Show suggestions and token animation trigger
            const readyEarlier = itemReadyTimes.filter(it => it.readyAtMs < scheduledPickupTimeMs).sort((a,b)=>a.readyAtMs-b.readyAtMs);
            let suggestion = '';
            if (readyEarlier.length) {
                suggestion = '\\nItems that will be ready earlier (you can collect them first):\\n' + readyEarlier.map(it => {
                    const r = new Date(it.readyAtMs);
                    const tstr = r.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    return `- ${it.name} (qty ${it.quantity}) at ${tstr}`;
                }).join('\\n');
            }

            showMessage(`Order Placed! Token: ${user.token}. Pickup (all items): ${etaString} â€” Wait: ${displayWaitTime}.${suggestion}`, 'success');

            // Display token in animated frame
            showTokenAnimated(user.token);

            setView('queue');
        }



        // --- CUSTOMER ORDER CANCELLATION & OWNER FUNCTIONS ---

        function cancelItemFromOrder(orderId, itemName) {
            const orderIndex = APP_STATE.orderQueue.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return showMessage('Order not found.', 'error');

            const order = APP_STATE.orderQueue[orderIndex];
            if (order.status === 'Ready' || order.status === 'Complete') {
                return showMessage('Cannot modify: Order is already READY or COMPLETE!', 'error');
            }
            
            const itemIndex = order.items.findIndex(i => i.name === itemName);
            if (itemIndex === -1) return showMessage('Item not found in order.', 'error');
            
            const cancelledItem = order.items[itemIndex];
            
            // 1. Restore Stock (Find item by name in the menu)
            const menuItem = APP_STATE.menu.find(m => m.name === itemName);
            if (menuItem) menuItem.stock += cancelledItem.quantity;

            // 2. Record Cancellation
            APP_STATE.cancelledOrders.push({
                id: 'C' + (APP_STATE.cancelledOrders.length + 1),
                token: order.token,
                reason: 'Customer Item Cancellation',
                item: cancelledItem.name,
                quantity: cancelledItem.quantity,
                timestamp: new Date().toLocaleTimeString()
            });

            // 3. Update Order Total and Dues
            const costOfItem = cancelledItem.price * cancelledItem.quantity;
            order.total -= costOfItem;
            if (order.paymentDue > 0) {
                 order.paymentDue -= costOfItem;
                 // Also update main udhar ledger
                 APP_STATE.udharLedger[order.token] = Math.max(0, (APP_STATE.udharLedger[order.token] || 0) - costOfItem);
            }
            order.items.splice(itemIndex, 1);
            
            // 4. If order is empty, remove the whole order
            if (order.items.length === 0) {
                APP_STATE.orderQueue.splice(orderIndex, 1);
                showMessage(`Order #${order.token} cancelled entirely as it was empty.`, 'info');
            } else {
                showMessage(`${itemName} cancelled from order #${order.token}.`, 'info');
            }

            // Re-render the queue view to update status
            setView('queue');
        }

        function cancelFullOrder(orderId) {
            const orderIndex = APP_STATE.orderQueue.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return showMessage('Order not found.', 'error');

            const order = APP_STATE.orderQueue[orderIndex];

            if (order.status === 'Ready' || order.status === 'Complete') {
                return showMessage('Cannot cancel: Order is already READY or COMPLETE!', 'error');
            }

            // 1. Restore Stock
            order.items.forEach(item => {
                const menuItem = APP_STATE.menu.find(m => m.name === item.name);
                if (menuItem) menuItem.stock += item.quantity;
            });
            
            // 2. Update Dues
            if (order.paymentDue > 0) {
                 APP_STATE.udharLedger[order.token] = Math.max(0, (APP_STATE.udharLedger[order.token] || 0) - order.paymentDue);
            }
            
            // 3. Record Cancellation
            APP_STATE.cancelledOrders.push({
                id: 'C' + (APP_STATE.cancelledOrders.length + 1),
                token: order.token,
                reason: 'Customer Full Order Cancellation',
                items: order.items.map(i => `${i.name} x${i.quantity}`).join(', '),
                timestamp: new Date().toLocaleTimeString()
            });

            // 4. Remove order
            APP_STATE.orderQueue.splice(orderIndex, 1);
            showMessage(`Order #${order.token} successfully cancelled.`, 'success');
            setView('queue');
        }

        function updateOrderStatus(orderId, newStatus) {
            const order = APP_STATE.orderQueue.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                
                // If order is completed, remove it from the active queue for the owner view
                if (newStatus === 'Complete') {
                    // We actually don't remove it from APP_STATE.orderQueue here to allow customer to see it until they log out/app reset.
                    // The owner view will filter out 'Complete' orders in the live queue.
                }
                
                showMessage(`Order #${order.token} status updated to ${newStatus}.`, 'success');
                setView('owner');
            }
        }

        function updateStock(itemId, change) {
            const item = APP_STATE.menu.find(i => i.id === itemId);
            if (item) {
                item.stock = Math.max(0, item.stock + change);
                showMessage(`${item.name} stock updated.`, 'success');
                setView('owner');
            }
        }

        function clearDues(token) {
            const amount = APP_STATE.udharLedger[token] || 0;
            const user = Object.values(APP_STATE.users).find(u => u.token === token);
            
            if (amount > 0) {
                // Settle any orders with payment due for this token
                APP_STATE.orderQueue.filter(o => o.token === token && o.paymentDue > 0).forEach(o => {
                    o.paymentDue = 0;
                });
                
                // Clear the ledger entry
                APP_STATE.udharLedger[token] = 0;
                
                // 1. Notify Owner (Simulated)
                const notification = {
                    id: 'N' + (APP_STATE.ownerNotifications.length + 1),
                    type: 'udhar_cleared',
                    token: token,
                    name: user ? user.name : 'Unknown User',
                    amount: amount,
                    timestamp: new Date().toLocaleTimeString()
                };
                APP_STATE.ownerNotifications.push(notification);
                
                // Update user object's udhar, if it exists
                if (user) user.udhar = 0;

                showMessage(`Dues of â‚¹${amount} for Token ${token} cleared successfully!`, 'success');
                
                // If owner is clearing dues from the panel, refresh the panel
                const currentUser = APP_STATE.users[APP_STATE.currentUserId];
                if (currentUser && currentUser.role === 'Owner') {
                    refreshOwnerPanel();
                }
                
                setView(APP_STATE.users[APP_STATE.currentUserId] && APP_STATE.users[APP_STATE.currentUserId].role === 'Owner' ? 'owner' : 'account');
            } else {
                showMessage(`Token ${token} has no outstanding dues.`, 'info');
            }
        }
        
        function clearUdhar() { // Customer side function
            const user = APP_STATE.users[APP_STATE.currentUserId];
            if (!user) return;
            // Clear dues logic is now consolidated in clearDues function
            clearDues(user.token);
        }
        
        // --- UI RENDERING FUNCTIONS ---
        
        function renderLogin() {
            const isLogin = currentAuthMode === 'login';

            let formFields = '';
            let submitText = isLogin ? 'Login' : 'Register';
            let roleSpecificFields = '';

            const selectedRole = document.querySelector('input[name="userRole"]:checked')?.value || 'Student';

            if (selectedRole === 'Student') {
                if (isLogin) {
                    roleSpecificFields = `
                        <div class="login-field">
                            <i data-lucide="user" class="input-icon"></i>
                            <input autocomplete="off" id="studentNameLogin" placeholder="Name" class="input-field" type="text" required> 
                        </div>
                        <div class="login-field">
                            <i data-lucide="hash" class="input-icon"></i>
                            <input autocomplete="off" id="rollNumberLogin" placeholder="Roll Number (e.g. 24EGICS040)" class="input-field" type="text" required> 
                        </div>
                    `;
                } else { // Register
                    roleSpecificFields = `
                        <div class="login-field">
                            <i data-lucide="building-2" class="input-icon"></i>
                            <input autocomplete="off" id="collegeName" placeholder="College Name" class="input-field" type="text" required>
                        </div>
                        <div class="login-field">
                            <i data-lucide="user" class="input-icon"></i>
                            <input autocomplete="off" id="studentName" placeholder="Name" class="input-field" type="text" required> 
                        </div>
                        <div class="login-field">
                            <i data-lucide="hash" class="input-icon"></i>
                            <input autocomplete="off" id="rollNumber" placeholder="Roll Number (Your unique ID)" class="input-field" type="text" required> 
                        </div>
                    `;
                }
            } else { // Owner
                 if (isLogin) {
                    roleSpecificFields = `
                        <div class="login-field">
                            <i data-lucide="key" class="input-icon"></i>
                            <input autocomplete="off" id="ownerId" placeholder="Owner ID (Must be O100)" value="O100" class="input-field" type="text" required> 
                        </div>
                    `;
                } else { // Register
                    roleSpecificFields = `
                        <div class="login-field">
                            <i data-lucide="store" class="input-icon"></i>
                            <input autocomplete="off" id="canteenName" placeholder="Canteen Name" class="input-field" type="text" required> 
                            <input type="hidden" id="ownerIdRegister" value="O100">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Your ID will be automatically generated (e.g., O101).</p>
                    `;
                }
            }

            formFields = `
                ${roleSpecificFields}
                <div class="login-field">
                    <i data-lucide="lock" class="input-icon"></i>
                    <input autocomplete="off" id="password" placeholder="Password (Use 123 for default users)" class="input-field" type="password" required>
                </div>
            `;


            return `
            <div class="login-card mx-auto">
                <h4 class="login-title">Access QuickBites</h4>

                <!-- Login/Register Toggle -->
                <div class="toggle-btn-group">
                    <button class="toggle-btn ${isLogin ? 'active' : ''}" onclick="setAuthMode('login')">LOGIN</button>
                    <button class="toggle-btn ${!isLogin ? 'active' : ''}" onclick="setAuthMode('register')">REGISTER</button>
                </div>
                
                <!-- Dynamic Role Selection -->
                <div class="mb-6">
                    <h5 class="text-sm text-gray-400 mb-2">Select your role:</h5>
                    <div class="radio-container mx-auto max-w-[250px]">
                        <input checked="" id="role-student" name="userRole" type="radio" value="Student" onchange="setView('login')" />
                        <label for="role-student">STUDENT</label>
                        
                        <input id="role-owner" name="userRole" type="radio" value="Owner" onchange="setView('login')" />
                        <label for="role-owner">OWNER</label>
                        
                        <div class="glider-container">
                            <div class="glider"></div>
                        </div>
                    </div>
                </div>
                
                <form onsubmit="event.preventDefault(); handleAuth();">
                    ${formFields}
                    <button class="login-btn" type="submit">
                        ${submitText}
                    </button> 
                </form>
            </div>
            `;
        }

        function renderOrder() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            // Safety check for user role
            if (!user || user.role === 'Owner') {
                setTimeout(() => setView('login'), 0); 
                return ''; // Return empty temporarily
            }
            
            // Get the current token, recalculated just in case the roll was updated
            const userToken = user.token || generateStudentTokenFromRoll(user.id);
            if (user.token !== userToken) user.token = userToken; // Update token if it was re-generated

            const cookedMenu = APP_STATE.menu.filter(i => i.category !== 'packet');
            const packetMenu = APP_STATE.menu.filter(i => i.category === 'packet');

            const cookedMenuHtml = cookedMenu.map(item => `
                <div class="flex items-start p-3 mb-3 border-b border-gray-700 last:border-b-0 ${item.stock <= 0 ? 'opacity-50' : ''}">
                    <!-- Added Image Thumbnail -->
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg mr-4 object-cover border border-gray-600 flex-shrink-0">
                    <div class="flex-grow flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="text-lg font-semibold">${item.name}</span>
                            <span class="text-sm text-gray-400">â‚¹${item.price} | Prep: ${item.prepTime * 60}s</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm mr-4 ${item.stock > 10 ? 'text-green-400' : (item.stock > 0 ? 'text-yellow-400' : 'text-red-500')}">
                                ${item.stock > 0 ? `${item.stock} left` : 'Out of Stock âŒ'}
                            </span>
                            <button onclick="addToCart('${item.id}')" 
                                    class="quantity-btn w-10 h-10 flex items-center justify-center disabled:opacity-30" 
                                    ${item.stock <= 0 ? 'disabled' : ''}>
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            const packetMenuHtml = packetMenu.map((item, index) => {
                return `
                    <div class="flex flex-col items-center justify-start p-3 w-32 flex-shrink-0 ${item.stock <= 0 ? 'opacity-50' : ''}">
                        <!-- Using image from APP_STATE.menu -->
                        <img src="${item.image}" 
                             onerror="this.src='https://placehold.co/100x100/1f2937/FFFAF0?text=Snack'" 
                             alt="${item.name}"
                             class="w-24 h-24 rounded-lg mb-2 border border-gray-700 object-cover">
                        <span class="text-sm font-semibold text-center leading-tight">${item.name}</span>
                        <span class="text-xs text-gray-400 mb-2">â‚¹${item.price}</span>
                        <button onclick="addToCart('${item.id}')" 
                                class="quantity-btn w-full h-8 flex items-center justify-center text-sm disabled:opacity-30" 
                                ${item.stock <= 0 ? 'disabled' : ''}>
                            <i data-lucide="shopping-cart" class="w-4 h-4 mr-1"></i> Add
                        </button>
                    </div>
                `;
            }).join('');
            
            const userRoleClass = user.role === 'Faculty' ? 'faculty' : (user.role === 'Owner' ? 'owner' : '');


            return `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- User Info Panel -->
                <div class="canteen-card p-6 lg:col-span-1 h-fit">
                    <div class="flex items-center mb-4 border-b border-gray-700 pb-4">
                        ${getProfileHtml(user)}
                        <div class="ml-4">
                            <h3 class="text-2xl font-bold flex items-center">
                                ${user.name}
                                <i data-lucide="${user.isPriority ? 'crown' : 'user'}" class="w-5 h-5 ml-2 ${user.isPriority ? 'text-yellow-500' : 'text-gray-400'}"></i>
                            </h3>
                            <p class="text-sm text-gray-400">${user.role} User</p>
                        </div>
                    </div>
                    
                    <!-- New Animated Token Component -->
                    <div class="token-button-wrapper">
                        <button type="button" class="token-button">
                            <span class="token-fold"></span>
                            <div class="token-points-wrapper">
                                <!-- Generate floating points with staggered animation -->
                                ${Array(10).fill(0).map((_, i) => `<i class="point" style="left: ${Math.random() * 100}%; animation-duration: ${1.5 + Math.random()}s; animation-delay: ${Math.random() * 2}s;"></i>`).join('')}
                            </div>
                            <span class="token-inner">
                                <p class="text-sm uppercase tracking-widest opacity-75">Your Token</p>
                                <span class="token-id">${userToken}</span>
                                ${user.isPriority ? '<span class="text-sm text-yellow-400">Priority User</span>' : ''}
                            </span>
                        </button>
                    </div>
                    <!-- End Animated Token Component -->

                    <div class="bg-red-900/30 p-3 rounded-lg border border-red-700/50 mt-4">
                        <p class="text-sm font-semibold text-red-300">Outstanding Udhar (Dues):</p>
                        <p class="text-xl font-bold text-red-400">â‚¹${APP_STATE.udharLedger[userToken] || 0}</p>
                    </div>
                    
                    <!-- Pay Later Checkbox -->
                    <div class="mt-4 flex items-center justify-start">
                        <input type="checkbox" id="payLater" class="form-checkbox h-5 w-5 text-red-600 bg-gray-700 border-gray-600 rounded">
                        <label for="payLater" class="ml-2 text-sm font-medium text-gray-300">Allow Pay Later (Udhar)</label>
                    </div>
                </div>

                <!-- Menu and Cart -->
                <div class="lg:col-span-2">
                    
                    <!-- Horizontal Scroll Snacks Section -->
                    <div class="canteen-card p-6 mb-8">
                        <h3 class="text-2xl font-bold mb-4 text-white border-b pb-2 border-gray-700 flex justify-between items-center">
                            Quick Snacks & Wafers
                            <span class="text-xs text-gray-400">Instant Pickup!</span>
                        </h3>
                        <div class="flex overflow-x-auto space-x-4 pb-2 -mx-2 px-2">
                            ${packetMenuHtml}
                        </div>
                    </div>
                    
                    <!-- Cooked Menu Section -->
                    <div class="canteen-card p-6 mb-8">
                        <h3 class="text-2xl font-bold mb-4 text-white border-b pb-2 border-gray-700">Cafeteria Menu (Cooked)</h3>
                        <div id="menu-list">
                            ${cookedMenuHtml}
                        </div>
                    </div>

                    <!-- Cart Section -->
                    <div class="canteen-card p-6">
                        <h3 class="text-2xl font-bold mb-4 flex items-center">
                            <i data-lucide="shopping-cart" class="w-6 h-6 mr-3 text-white"></i>
                            Your Order Cart
                        </h3>
                        <div id="cart-items" class="min-h-[50px] text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
                            <!-- Cart items rendered here by updateCartUI() -->
                        </div>
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700">
                            <span class="text-xl font-bold">Total: <span id="cart-total" style="color:var(--primary-color);">â‚¹0</span></span>
                            <button onclick="placeOrder()" class="glow-button px-6 py-2 rounded-lg disabled:opacity-30 disabled:shadow-none" id="place-order-btn" disabled>
                                Place Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        
function getOrderRowHtml(o) {
  const lines = [];
  lines.push('<div style=\"border:1px solid #eee;padding:8px;margin-bottom:6px;border-radius:8px;\">');
  lines.push('<div><strong>' + o.id + '</strong> â€” Token: ' + (o.token||'') + ' â€” Status: ' + o.status + '</div>');
  lines.push('<div>ETA: ' + (o.eta||'') + ' Total: ' + (o.total||0) + '</div>');
  if (o.items && o.items.length) {
    lines.push('<div>Items:<ul style=\"margin:6px 0 0 18px;padding:0;\">' + o.items.map(i=>'<li>'+i.name+' x'+i.quantity+'</li>').join('') + '</ul></div>');
  }
  // Owner controls
  const currentUser = APP_STATE.users[APP_STATE.currentUserId];
  if (currentUser && currentUser.isOwner) {
    lines.push('<div style=\"margin-top:6px\">');
    lines.push('<button onclick=\"ownerMarkReady(\\''+o.id+'\\')\">Mark Ready</button> ');
    lines.push('<button onclick=\"ownerMarkComplete(\\''+o.id+'\\')\">Complete</button> ');
    lines.push('<button onclick=\"ownerCancelOrder(\\''+o.id+'\\')\">Cancel</button>');
    lines.push('</div>');
    if (o.paymentDue && o.paymentDue>0) {
      lines.push('<div style=\"margin-top:6px\"><em>Payment Due: '+o.paymentDue+'</em> <button onclick=\"settlePayment(\\''+o.id+'\\')\">Settle</button></div>');
    }
  }
  lines.push('</div>');
  return lines.join('');
}
function renderQueue() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            // Safety check for user role
            if (!user || user.role === 'Owner') {
                setTimeout(() => setView('login'), 0); 
                return '';
            }
            
            // Get the current token
            const userToken = user.token || generateStudentTokenFromRoll(user.id);

            const myOrder = APP_STATE.orderQueue.find(o => o.token === userToken && o.status !== 'Complete' && o.status !== 'Cancelled');
            
            // Sort: Ready > In Prep > Queued. Faculty (F-prefix) priority first within status groups.
            const allOrders = APP_STATE.orderQueue.slice()
                .filter(o => o.status !== 'Complete' && o.status !== 'Cancelled') // Filter out completed and cancelled orders
                .sort((a, b) => {
                    const aIsPrio = a.token.startsWith('F');
                    const bIsPrio = b.token.startsWith('F');

                    // Priority Check
                    if (aIsPrio && !bIsPrio) return -1;
                    if (!aIsPrio && bIsPrio) return 1;

                    // Status Check
                    const statusOrder = { 'Ready': 1, 'In Prep': 2, 'Queued': 3 };
                    return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99); // Use 99 for unknown status
                });

            const queueHtml = allOrders.map(order => {
                const isMine = order.token === userToken;
                const statusColor = { 'Ready': 'text-green-400', 'In Prep': 'text-yellow-400', 'Queued': 'text-gray-400' };

                return `
                    <div class="flex justify-between items-center p-4 mb-3 rounded-lg ${isMine ? 'bg-blue-600/20 border-l-4 border-blue-400' : 'bg-gray-700/30'}">
                        <div class="flex flex-col">
                            <span class="text-2xl font-bold" style="color:${isMine ? 'var(--primary-color)' : 'white'};">#${order.token}</span>
                            <span class="text-xs text-gray-400">${isMine ? 'Your Order' : '---'}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-semibold ${statusColor[order.status]}">${order.status}</span>
                            <p class="text-sm text-gray-400">Pickup: ${order.eta}</p>
                        </div>
                    </div>
                `;
            }).join('');

            const myOrderDetailsHtml = myOrder ? `
                <div class="bg-gray-700/50 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-lg mb-2 text-white">Order Details (Total: â‚¹${myOrder.total})</h4>
                    ${myOrder.items.map(item => `
                        <div class="flex justify-between items-center text-sm py-1 border-b border-gray-600 last:border-b-0">
                            <span class="text-gray-300">${item.name} x ${item.quantity}</span>
                            <button onclick="cancelItemFromOrder('${myOrder.id}', '${item.name}')" 
                                    class="text-red-400 hover:text-red-500 text-xs disabled:opacity-50"
                                    ${myOrder.status === 'Ready' ? 'disabled' : ''}>
                                Cancel Item
                            </button>
                        </div>
                    `).join('')}
                    
                    <button onclick="cancelFullOrder('${myOrder.id}')" 
                            class="glow-button w-full mt-4 py-2 text-sm bg-red-600 hover:bg-red-500 disabled:opacity-50"
                            style="--primary-color: #f87171;" 
                            ${myOrder.status === 'Ready' ? 'disabled' : ''}>
                        Cancel Entire Order
                    </button>
                </div>
            ` : '';

            return `
            <div class="max-w-xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-6">Real-Time Queue</h2>
                <div class="canteen-card p-6">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2 border-gray-700">Your Current Status</h3>
                    <div class="token-display p-4 rounded-lg mb-6 text-center ${!myOrder ? 'opacity-50' : ''}">
                        ${myOrder ? `
                            <p class="text-sm text-gray-400">Your Token is currently:</p>
                            <p class="text-4xl font-extrabold mb-1 flex items-center justify-center" style="color:var(--primary-color);">
                                #${myOrder.token}
                                ${myOrder.status === 'Ready' ? 
                                    `<span class="text-sm ml-4 px-2 py-1 rounded-full bg-green-600 text-white animate-pulse shadow-lg" style="box-shadow: 0 0 10px rgba(74, 222, 128, 0.7);">YOUR TURN!</span>` : ''}
                            </p>
                            <p class="text-2xl font-semibold ${myOrder.status === 'Ready' ? 'text-green-400' : 'text-yellow-400'}">${myOrder.status}</p>
                            <p class="text-sm text-gray-400">Estimated Pickup: ${myOrder.eta}</p>
                            ${myOrderDetailsHtml}
                        ` : '<p class="text-gray-400">No active order found. Place an order on the "Order Now" tab.</p>'}
                    </div>

                    <h3 class="text-xl font-bold mb-4 border-b pb-2 border-gray-700">Full Queue List (${allOrders.length} active)</h3>
                    <div class="h-96 overflow-y-auto pr-2">
                        ${queueHtml.length > 0 ? queueHtml : '<p class="text-gray-400 text-center py-4">The kitchen is clear! Order now!</p>'}
                    </div>
                </div>
            </div>
            `;
        }

        function renderLeaderboard() {
            // Filter out 'Owner' and sort by orders placed (descending)
            const sortedUsers = Object.values(APP_STATE.users)
                .filter(u => u.role !== 'Owner')
                .sort((a, b) => b.ordersPlaced - a.ordersPlaced);

            const leaderboardHtml = sortedUsers.slice(0, 10).map((user, index) => {
                const rank = index + 1;
                let badgeIcon = '';
                if (rank === 1) badgeIcon = '<i data-lucide="award" class="w-5 h-5 text-yellow-400 mr-2 fill-yellow-400/50"></i>';
                else if (rank === 2) badgeIcon = '<i data-lucide="award" class="w-5 h-5 text-gray-300 mr-2 fill-gray-300/50"></i>';
                else if (rank === 3) badgeIcon = '<i data-lucide="award" class="w-5 h-5 text-orange-400 mr-2 fill-orange-400/50"></i>';
                else badgeIcon = '<i data-lucide="hash" class="w-5 h-5 text-gray-500 mr-2"></i>';

                return `
                    <div class="leader-item flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="w-6 text-lg font-bold mr-4 text-center ${rank <= 3 ? 'text-white' : 'text-gray-400'}">${rank}.</span>
                            ${badgeIcon}
                            <span class="font-semibold">${user.name}</span>
                        </div>
                        <span class="text-sm text-gray-300">${user.ordersPlaced} orders</span>
                    </div>
                `;
            }).join('');

            return `
            <div class="max-w-lg mx-auto">
                
                <button class="leaderboard-btn-glow" onclick="setView('leaderboard')">
                    <span>ðŸ† QUICKBITES LEADERBOARD ðŸ†</span>
                </button>
                
                <div class="canteen-card p-6">
                    ${leaderboardHtml.length > 0 ? leaderboardHtml : '<p class="text-gray-400 text-center py-4">No data to display yet. Place some orders!</p>'}
                </div>
            </div>
            `;
        }
        
        function renderAccount() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            
            // Safety check for user
            if (!user) {
                setTimeout(() => setView('login'), 0); 
                return '';
            }
            
            // Get the current token
            const userToken = user.token || generateStudentTokenFromRoll(user.id);
            if (user.token !== userToken) user.token = userToken;

            return `
            <div class="max-w-md mx-auto">
                <h2 class="text-3xl font-bold text-center mb-6">Account & Settings</h2>
                
                <div class="canteen-card p-6 mb-6 space-y-3">
                    <div class="flex items-center border-b border-gray-700 pb-4 mb-4">
                        ${getProfileHtml(user)}
                        <div class="ml-4">
                            <span class="text-gray-400 flex items-center mb-1"><i data-lucide="user-check" class="w-5 h-5 mr-2"></i> User:</span>
                            <span class="font-semibold text-lg">${user.name} (${user.id})</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                        <span class="text-gray-400 flex items-center"><i data-lucide="fingerprint" class="w-5 h-5 mr-2"></i> Token:</span>
                        <span class="font-semibold" style="color:var(--primary-color);">${userToken}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 flex items-center"><i data-lucide="utensils" class="w-5 h-5 mr-2"></i> Total Orders:</span>
                        <span class="font-semibold">${user.ordersPlaced}</span>
                    </div>
                </div>

                <div class="canteen-card p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2 border-gray-700">Financial Ledger (Udhar)</h3>
                    <div class="flex justify-between items-center bg-red-900/30 p-3 rounded-lg border border-red-700/50 mb-4">
                        <span class="text-red-300 font-semibold">Pending Dues:</span>
                        <span class="text-2xl font-bold text-red-400">â‚¹${APP_STATE.udharLedger[userToken] || 0}</span>
                    </div>
                    <button class="login-btn w-full py-2 text-sm bg-green-600 hover:bg-green-500" style="--primary-color: #10B981;" onclick="clearUdhar()" ${APP_STATE.udharLedger[userToken] <= 0 ? 'disabled' : ''}>
                        Clear Dues Now (Simulated Payment)
                    </button>
                </div>
                
                <!-- MOVED LOGOUT INTO A CARD-STYLE BUTTON FOR BETTER VISUAL HIERARCHY -->
                <button onclick="logout()" class="login-btn w-full py-2 text-sm bg-red-600 hover:bg-red-500" style="--primary-color: #F87171;">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2 inline-block"></i> Logout
                </button>
            </div>
            `;
        }

        function renderOwnerDashboard() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            
            // Safety check for user role
            if (!user || user.role !== 'Owner') {
                setTimeout(() => setView('login'), 0); 
                return '';
            }
            
            // --- Live Orders Processing ---
            const liveOrders = APP_STATE.orderQueue.filter(o => o.status !== 'Complete' && o.status !== 'Cancelled');
            const liveOrdersHtml = liveOrders.length > 0 ? liveOrders.map(order => `
                <div class="bg-gray-800 p-4 rounded-lg mb-3 border border-gray-700">
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <span class="text-2xl font-bold ${order.token.startsWith('F') ? 'text-yellow-400' : 'text-blue-400'}">#${order.token}</span>
                        <span class="text-sm text-gray-400">${order.eta} ETA | â‚¹${order.total}</span>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">${order.items.map(i => `${i.name} x${i.quantity}`).join(', ')}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="font-semibold ${order.status === 'Ready' ? 'text-green-400' : 'text-yellow-400'}">${order.status}</span>
                        <div class="space-x-2">
                            <button onclick="updateOrderStatus('${order.id}', 'Ready')" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 text-xs rounded-full">Ready</button>
                            <button onclick="updateOrderStatus('${order.id}', 'Complete')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 text-xs rounded-full">Complete</button>
                            <button onclick="ownerCancelOrder('${order.id}')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 text-xs rounded-full">Cancel</button>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-400 text-center py-4">No active orders in the queue.</p>';

            // --- Udhar Ledger Processing ---
            // Note: Use APP_STATE.users to get names for tokens not explicitly in ledger keys (as ledger only holds non-zero udhar)
            const udharUsers = Object.keys(APP_STATE.udharLedger)
                .filter(token => APP_STATE.udharLedger[token] > 0)
                .map(token => {
                    const foundUser = Object.values(APP_STATE.users).find(u => u.token === token);
                    return { token, amount: APP_STATE.udharLedger[token], name: foundUser ? foundUser.name : 'Token ' + token };
                });

            const udharHtml = udharUsers.length > 0 ? udharUsers.map(user => `
                <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-b-0">
                    <div>
                        <span class="font-semibold">${user.name}</span>
                        <span class="text-xs text-gray-500 block">Token: ${user.token}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-bold text-red-400">â‚¹${user.amount}</span>
                        <button onclick="clearDues('${user.token}')" class="bg-red-700 hover:bg-red-600 text-white px-3 py-1 text-xs rounded-full">Settle</button>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-400 text-center py-4">No outstanding dues recorded.</p>';
            
            // --- Notification Log Processing ---
            const notificationHtml = APP_STATE.ownerNotifications.slice().reverse().slice(0, 5).map(n => `
                <div class="bg-green-900/30 p-3 rounded-lg mb-2 flex items-center">
                    <i data-lucide="badge-check" class="w-5 h-5 mr-3 text-green-400 flex-shrink-0"></i>
                    <p class="text-sm text-green-300">
                        <span class="font-bold">${n.name} (#${n.token})</span> cleared dues of <span class="font-bold">â‚¹${n.amount}</span>.
                    </p>
                    <span class="text-xs text-gray-500 ml-auto">${n.timestamp}</span>
                </div>
            `).join('');

            // --- Stock Management Processing ---
            const stockHtml = APP_STATE.menu.map(item => `
                <div class="flex justify-between items-center py-2 border-b border-gray-700">
                    <span class="w-1/3">${item.name}</span>
                    <span class="w-1/4 text-center ${item.stock < 5 ? 'text-red-400' : 'text-green-400'}">${item.stock} left</span>
                    <div class="w-1/3 flex justify-end space-x-2">
                        <button onclick="updateStock('${item.id}', 5)" class="bg-green-800 hover:bg-green-700 text-white w-8 h-6 text-xs rounded">+</button>
                        <button onclick="updateStock('${item.id}', -1)" class="bg-red-800 hover:bg-red-700 text-white w-8 h-6 text-xs rounded">-</button>
                    </div>
                </div>
            `).join('');

            // --- Cancellation Board Processing ---
            const cancelledHtml = APP_STATE.cancelledOrders.slice().reverse().slice(0, 10).map(c => `
                <div class="bg-gray-800/50 p-3 rounded-lg mb-2">
                    <p class="font-semibold text-sm text-red-300">${c.reason} (Token: ${c.token})</p>
                    <p class="text-xs text-gray-400">Time: ${c.timestamp}</p>
                    ${c.item ? 
                        `<p class="text-xs text-gray-300 mt-1">Item Removed: ${c.item} x ${c.quantity}</p>` :
                        `<p class="text-xs text-gray-300 mt-1">Items Cancelled: ${c.items}</p>`
                    }
                </div>
            `).join('');

            return `
                <h2 class="text-3xl font-bold text-center mb-6 text-white">${user.name}'s Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    <!-- Live Orders -->
                    <div class="canteen-card p-6 lg:col-span-2">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-700">Live Orders (${liveOrders.length})</h3>
                        <div class="h-96 overflow-y-auto pr-2">
                            ${liveOrdersHtml}
                        </div>
                    </div>

                    <!-- Stock Management -->
                    <div class="canteen-card p-6">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-700">Stock & Inventory</h3>
                        <div class="h-96 overflow-y-auto pr-2">
                            ${stockHtml}
                        </div>
                    </div>

                    <!-- Digital Dues Ledger -->
                    <div class="canteen-card p-6 lg:col-span-1">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-700">Digital Dues Ledger (Udhar)</h3>
                        <div class="h-96 overflow-y-auto pr-2">
                            ${udharHtml}
                        </div>
                    </div>
                    
                    <!-- Notification Log -->
                    <div class="canteen-card p-6 lg:col-span-1">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-700">Payment Notifications</h3>
                        <div class="h-auto max-h-56 overflow-y-auto pr-2">
                            ${notificationHtml || '<p class="text-gray-400 text-center py-4">No recent payment notifications.</p>'}
                        </div>
                    </div>

                    <!-- Cancellation Board -->
                    <div class="canteen-card p-6 lg:col-span-2">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-700">Cancelled Orders & Items (Recent)</h3>
                        <div class="h-96 overflow-y-auto pr-2">
                            ${cancelledHtml || '<p class="text-gray-400 text-center py-4">No cancellations recorded.</p>'}
                        </div>
                    </div>

                </div>
                <button onclick="logout()" class="glow-button w-full mt-6 py-3 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm" style="--primary-color: #9CA3AF;">Logout</button>
            `;
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            // Check if a user ID is pre-set, otherwise start at login
            if (!APP_STATE.currentUserId || !APP_STATE.users[APP_STATE.currentUserId]) {
                APP_STATE.currentUserId = null;
                setView('login');
            } else {
                const user = APP_STATE.users[APP_STATE.currentUserId];
                
                if (user.role === 'Owner') {
                    setView('owner');
                } else {
                    setView('order');
                }
            }
        };

    </script>
</body>
</html>
