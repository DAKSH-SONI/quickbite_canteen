<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBite - Dynamic Canteen Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&display=swap" rel="stylesheet">
    <!-- Icons from Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-color: #FFFAF0; /* CREAMY WHITE for highlights */
            --dark-bg: #111827; /* Dark Slate Blue/Black background */
            --card-bg: #1f2937; /* Slightly lighter card background */
            --login-card-bg: #2a2b38; /* Your login card background */
            --login-input-bg: #1f2029; /* Your login input background */
            --text-color: #f3f4f6;
            --accent-glow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color);
        }

        body {
            font-family: 'Times New Roman', serif;
            background-color: var(--dark-bg);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Base Card Styling (Used in all non-login views) */
        .canteen-card {
            background-color: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .canteen-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        }

        /* Standard Glow Button Styling */
        .glow-button {
            background: var(--primary-color);
            color: var(--dark-bg);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glow-button:hover {
            background: #fff;
            box-shadow: var(--accent-glow);
        }

        .glow-button:active {
            transform: scale(0.98);
        }

        /* --- USER PROVIDED LOGIN CARD STYLES --- */
        .login-card {
            width: 100%;
            max-width: 320px;
            padding: 1.9rem 1.2rem;
            text-align: center;
            background: var(--login-card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .login-title {
            margin-bottom: 1rem;
            font-size: 1.8em;
            font-weight: bold;
            color: #f5f5f5;
        }

        .login-field {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5em;
            background-color: var(--login-input-bg);
            border-radius: 6px;
            padding: .75em 1em;
            border: 1px solid transparent;
            transition: border-color 0.3s;
        }
        .login-field:focus-within {
             border-color: var(--primary-color);
        }

        .input-icon {
            height: 1em;
            width: 1em;
            fill: var(--primary-color);
        }

        .input-field {
            background: none;
            border: none;
            outline: none;
            width: 100%;
            color: var(--text-color);
            padding: 0;
        }
        
        .login-btn {
            margin-top: 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: .9em;
            text-transform: uppercase;
            padding: 0.8em 1.2em;
            background-color: var(--primary-color);
            color: var(--login-card-bg);
            box-shadow: 0 8px 24px 0 rgba(255, 250, 240, 0.2); /* Adjusted glow opacity */
            transition: all .3s ease-in-out;
            width: 100%;
        }

        .login-btn:hover {
            background-color: #fff;
            color: #5e6681;
            box-shadow: 0 8px 24px 0 rgba(255, 250, 240, 0.4); /* Adjusted hover glow */
        }
        
        /* --- DYNAMIC RADIO BUTTON STYLES --- */
        .radio-container {
            --main-color: var(--primary-color);
            --main-color-opacity: #FFFAF01c; /* Creamy opacity */
            --total-radio: 2; 
            display: flex;
            flex-direction: column;
            position: relative;
            padding-left: 0.5rem;
            background-color: var(--login-input-bg);
            border-radius: 6px;
        }
        .radio-container input {
            cursor: pointer;
            appearance: none;
        }
        .radio-container .glider-container {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(27, 27, 27, 1) 50%, rgba(0, 0, 0, 0) 100%);
            width: 1px;
            border-radius: 6px;
        }
        .radio-container .glider-container .glider {
            position: relative;
            height: calc(100% / var(--total-radio));
            width: 100%;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, var(--main-color) 50%, rgba(0, 0, 0, 0) 100%);
            transition: transform 0.5s cubic-bezier(0.37, 1.95, 0.66, 0.56);
        }
        .radio-container .glider-container .glider::before {
            content: "";
            position: absolute;
            height: 60%;
            width: 300%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--main-color);
            filter: blur(10px);
        }
        .radio-container .glider-container .glider::after {
            content: "";
            position: absolute;
            left: 0;
            height: 100%;
            width: 150px;
            background: linear-gradient(90deg, var(--main-color-opacity) 0%, rgba(0, 0, 0, 0) 100%);
        }
        .radio-container label {
            cursor: pointer;
            padding: 0.75rem 1rem;
            position: relative;
            color: #9ca3af;
            transition: all 0.3s ease-in-out;
            text-align: left;
        }
        .radio-container input:checked + label {
            color: var(--main-color);
            font-weight: bold;
        }
        .radio-container input:nth-of-type(1):checked ~ .glider-container .glider {
            transform: translateY(0);
        }
        .radio-container input:nth-of-type(2):checked ~ .glider-container .glider {
            /* Note: This logic assumes only 2 roles are visible in the radio selector at any time. 
               The third role 'Faculty/Staff' is currently hidden in the HTML but present in JS data.
               If a third role (e.g., Faculty) is added back to HTML, this logic needs adjustment.
            */
            transform: translateY(100%); 
        }
        /* --- END DYNAMIC RADIO BUTTON STYLES --- */


        /* --- LEADERBOARD GLOW BUTTON STYLES (Adapted) --- */
        .leaderboard-btn-glow {
            position: relative;
            text-decoration: none;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            line-height: 55px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            height: 60px;
            margin-bottom: 2rem;
            display: block;
            /* Added reflection from user's provided style */
            -webkit-box-reflect: bottom 1px linear-gradient(transparent, #0004);
        }

        .leaderboard-btn-glow span {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            top: 4px;
            right: 4px;
            bottom: 4px;
            left: 4px;
            text-align: center;
            background: var(--card-bg); 
            color: rgba(255, 255, 255, 0.9);
            transition: 0.5s;
            z-index: 1;
            padding: 0 10px;
        }
        /* Added internal shine effect */
        .leaderboard-btn-glow span::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: rgba(255, 255, 255, 0.1);
        }

        .leaderboard-btn-glow:hover span {
            color: var(--primary-color);
        }

        .leaderboard-btn-glow::before,
        .leaderboard-btn-glow::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-size: 400%;
            opacity: 0;
            transition: 0.5s;
            /* Using the full rainbow gradient from the user's snippet */
            background: linear-gradient(
                45deg,
                #91155d, /* Dark Magenta */
                #525296, /* Indigo */
                #0f0,    /* Green */
                #ff0,    /* Yellow */
                #fb0094, /* Pink */
                #00f,    /* Blue */
                #0f0,
                #ff0
            );
            animation: animate123 10s linear infinite; /* Adjusted speed to 10s for smoother web look */
        }
        .leaderboard-btn-glow::after {
            filter: blur(20px);
        }

        .leaderboard-btn-glow:hover::before,
        .leaderboard-btn-glow:hover::after {
            opacity: 1;
        }

        @keyframes animate123 {
            0% { background-position: 0 0; }
            50% { background-position: 300% 0; }
            100% { background-position: 0 0; }
        }
        /* --- END LEADERBOARD GLOW BUTTON STYLES --- */
        
        /* --- READY BADGE STYLES --- */
        .ready-badge {
            background-color: #10b981; /* Tailwind Green-600 */
            color: #111827;
            font-size: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.8); /* Green glow */
            animation: pulse-green 1.5s infinite;
            display: inline-block;
            margin-bottom: 10px;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.8);
            }
            50% {
                box-shadow: 0 0 25px rgba(16, 185, 129, 1);
            }
            100% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.8);
            }
        }

        /* --- TOKEN DYNAMIC LIGHTING STYLES (NEW) --- */
        .token-button {
            cursor: default; /* Not a clickable button functionally */
            font-size: 1.4rem;
            border-radius: 16px;
            border: none;
            padding: 2px;
            /* Main gradient adapted to theme: start with white/cream glow, end in dark slate */
            background: radial-gradient(circle 80px at 80% -10%, var(--primary-color), var(--dark-bg));
            position: relative;
            width: 100%;
            display: block;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .token-button::after {
            content: "";
            position: absolute;
            width: 65%;
            height: 60%;
            border-radius: 120px;
            top: 0;
            right: 0;
            box-shadow: 0 0 20px #ffffff38;
            z-index: -1;
        }

        .token-blob1 {
            position: absolute;
            width: 70px;
            height: 100%;
            border-radius: 16px;
            bottom: 0;
            left: 0;
            /* Blue/Cyan light source for contrast */
            background: radial-gradient(
                circle 60px at 0% 100%,
                #3fe9ff,
                #0000ff80,
                transparent
            );
            box-shadow: -10px 10px 30px #0051ff2d;
            animation: moveBlob 4s infinite ease-in-out;
        }

        @keyframes moveBlob {
            0% { transform: translateX(0); }
            50% { transform: translateX(20px) scaleX(1.1); }
            100% { transform: translateX(0); }
        }

        .token-inner {
            padding: 14px 25px;
            border-radius: 14px;
            color: #fff;
            z-index: 3;
            position: relative;
            /* Inner gradient adapted to theme: dark card background */
            background: radial-gradient(circle 80px at 80% -50%, #777777, var(--dark-bg));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .token-inner::before {
            content: "";
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            border-radius: 14px;
            background: radial-gradient(
                circle 60px at 0% 100%,
                #00e1ff1a,
                #0000ff11,
                transparent
            );
            position: absolute;
        }
        /* --- END TOKEN DYNAMIC LIGHTING STYLES --- */

        /* --- Other original styles (Leaderboard item, icons, etc.) --- */
        .settings-menu {
            display: flex;
            flex-direction: column;
            width: 100%;
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-value {
            background-color: transparent;
            border: none;
            padding: 15px 20px;
            color: white;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-radius: 4px;
            text-align: left;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .settings-value:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .settings-value:focus, .settings-value:active {
            background-color: rgba(255, 250, 240, 0.1);
            outline: none;
        }

        .settings-value svg {
            width: 20px;
            height: 20px;
            stroke: #9ca3af; /* Default icon color */
        }
        
        .settings-value:hover svg {
            stroke: var(--primary-color);
        }

        .token-display {
            background: linear-gradient(135deg, #252b35, #1f2937);
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .leader-item {
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .leader-item:nth-child(1) { background-color: #d9770644; border-left: 4px solid var(--primary-color); }
        .leader-item:nth-child(2) { background-color: #9ca3af44; border-left: 4px solid #d1d5db; }
        .leader-item:nth-child(3) { background-color: #b4530944; border-left: 4px solid #fb923c; }
        .leader-item:hover { background-color: #4b5563; }

        .icon-container {
            transition: all 0.3s ease;
        }
        .icon-container:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
    </style>
</head>
<body onload="setView('login')">

    <div id="app" class="w-full max-w-5xl">
        <!-- Main Content Area -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold tracking-widest text-white mb-2" style="text-shadow: 0 0 10px var(--primary-color);">
                QUICKBITE
            </h1>
            <p class="text-gray-400 text-lg">Smart Canteen Order System</p>
        </header>

        <!-- Dynamic View Container -->
        <div id="view-container" class="transition-all duration-500 pb-20 md:pb-10">
            <!-- Content will be injected here -->
        </div>

        <!-- Navigation Bar (Hidden for Owner) -->
        <nav id="navbar" class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-gray-700 shadow-2xl z-50">
            <div class="flex justify-around max-w-xl mx-auto">
                <button onclick="setView('order')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="utensils" class="w-6 h-6 mb-1"></i>
                    Order Now
                </button>
                <button onclick="setView('queue')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="clock-4" class="w-6 h-6 mb-1"></i>
                    My Queue
                </button>
                <button onclick="setView('leaderboard')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="trophy" class="w-6 h-6 mb-1"></i>
                    Leaderboard
                </button>
                <button onclick="setView('account')" class="icon-container flex flex-col items-center text-sm p-2 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="settings" class="w-6 h-6 mb-1"></i>
                    Account
                </button>
            </div>
        </nav>
    </div>

    <script>
        // --- DATA / STATE MANAGEMENT (Simulated) ---

        const APP_STATE = {
            users: {
                // Initial users for demonstration
                'F101': { id: 'F101', name: 'Dr. Jane Smith', role: 'Faculty', token: 'F-101', udhar: 450, ordersPlaced: 55, isPriority: true, isLoggedIn: true },
                'S503': { id: 'S503', name: 'Aarav Sharma', role: 'Student', token: 'S-503', udhar: 120, ordersPlaced: 92, isPriority: false, isLoggedIn: true },
                'S888': { id: 'S888', name: 'Priya Verma', role: 'Student', token: 'S-888', udhar: 0, ordersPlaced: 15, isPriority: false, isLoggedIn: true },
                'O100': { id: 'O100', name: 'Canteen Owner', role: 'Owner', token: 'O-100', udhar: 0, ordersPlaced: 0, isPriority: false, isLoggedIn: true },
            },
            currentUserId: null, // Starts as null to force login view

            menu: [
                { id: 'samosa', name: 'Samosa', price: 20, stock: 25 },
                { id: 'tea', name: 'Masala Tea', price: 15, stock: 99 },
                { id: 'coffee', name: 'Cold Coffee', price: 60, stock: 12 },
                { id: 'thali', name: 'Veg Thali', price: 100, stock: 4 },
                { id: 'sandwich', name: 'Grilled Sandwich', price: 75, stock: 0 },
            ],

            orderQueue: [
                { token: 'S-503', items: 'Tea, Thali', status: 'In Prep', eta: '10:45 AM' },
                { token: 'F-101', items: 'Samosa, Coffee', status: 'Ready', eta: '10:40 AM' },
                { token: 'S-210', items: 'Sandwich', status: 'Queued', eta: '10:50 AM' },
            ],

            udharLedger: {
                'F-101': 450,
                'S-503': 120,
                'S-888': 0,
                'S-210': 30,
            }
        };

        // --- AUTHENTICATION / REGISTRATION ---

        function login() {
            const id = document.getElementById('loginId').value.trim();
            const role = document.querySelector('input[name="userRole"]:checked')?.value;
            
            if (!id || !role) {
                showMessage('Please enter your ID and select a role.', 'error');
                return;
            }

            // Check if user is trying to log in as Owner
            if (role === 'Owner') {
                if (id === 'O100') {
                    APP_STATE.currentUserId = id;
                    showMessage('Owner Dashboard accessed.', 'success');
                    setView('owner');
                    return;
                } else {
                    showMessage('Invalid ID for Owner role.', 'error');
                    return;
                }
            }

            // --- Customer (Student/Faculty) Login Logic ---
            const userExists = APP_STATE.users[id];

            if (!userExists) {
                // Assuming "Faculty/Staff" role is selected via other means if we add it back
                const token = (role === 'Faculty' ? 'F' : 'S') + Math.floor(Math.random() * 900 + 100);
                const newUser = {
                    id: id,
                    name: id,
                    role: role,
                    token: token,
                    udhar: 0,
                    ordersPlaced: 0,
                    isPriority: role === 'Faculty',
                    isLoggedIn: true
                };
                APP_STATE.users[id] = newUser;
                APP_STATE.udharLedger[token] = 0;
                APP_STATE.currentUserId = id;
                showMessage(`Welcome! Your new token is **${token}**.`, 'success');
            } else {
                APP_STATE.currentUserId = id;
                showMessage(`Welcome back, ${userExists.name}!`, 'success');
            }
            
            setView('order');
        }

        // --- UI RENDERING FUNCTIONS ---

        function renderLogin() {
            const isLoggedIn = APP_STATE.currentUserId && APP_STATE.users[APP_STATE.currentUserId]?.isLoggedIn;
            if (isLoggedIn) {
                const userRole = APP_STATE.users[APP_STATE.currentUserId]?.role;
                if (userRole === 'Owner') {
                    setView('owner');
                } else {
                    setView('order');
                }
                return;
            }

            // Note: The original radio button structure only showed Student/Faculty. 
            // The provided update shows Student/Owner. I'm keeping the Student/Owner structure for now.
            return `
            <div class="login-card mx-auto">
                <h4 class="login-title">Access QuickBite</h4>

                <!-- Dynamic Radio Container for Role Selection -->
                <div class="mb-8">
                    <h5 class="text-sm text-gray-400 mb-2">Select your role:</h5>
                    <div class="radio-container mx-auto max-w-[250px]">
                        <input checked="" id="role-student" name="userRole" type="radio" value="Student" />
                        <label for="role-student">STUDENT/STAFF</label>
                        
                        <input id="role-owner" name="userRole" type="radio" value="Owner" />
                        <label for="role-owner">OWNER</label>
                        
                        <div class="glider-container">
                            <div class="glider"></div>
                        </div>
                    </div>
                </div>
                
                <form onsubmit="event.preventDefault(); login();">
                    <div class="login-field">
                        <svg class="input-icon" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                            <path d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"></path>
                        </svg>
                        <input autocomplete="off" id="loginId" placeholder="ID (e.g., S503 or O100)" class="input-field" name="loginId" type="text"> 
                    </div> 
                    
                    <button class="login-btn" type="submit">
                        Login / Get Token
                    </button> 
                </form>
            </div>
            `;
        }
        
        // Refactored menu rendering for Order View (since it was hardcoded before)
        function renderMenuList() {
            const menuList = document.getElementById('menu-list');
            if (!menuList) return;

            // Simplified: No live filter logic needed for this update, reverting to simple list
            const menuHtml = APP_STATE.menu.map(item => `
                <div class="flex justify-between items-center p-3 mb-3 border-b border-gray-700 last:border-b-0 ${item.stock <= 0 ? 'opacity-50' : ''}">
                    <div class="flex flex-col">
                        <span class="text-lg font-semibold">${item.name}</span>
                        <span class="text-sm text-gray-400">‚Çπ${item.price}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm mr-4 ${item.stock > 10 ? 'text-green-400' : (item.stock > 0 ? 'text-yellow-400' : 'text-red-500')}">
                            ${item.stock > 0 ? `${item.stock} left` : 'Out of Stock ‚ùå'}
                        </span>
                        <button onclick="addToCart('${item.id}')" 
                                class="w-10 h-10 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-colors disabled:opacity-30" 
                                ${item.stock <= 0 ? 'disabled' : ''}>
                            <i data-lucide="plus" class="w-5 h-5 mx-auto"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            menuList.innerHTML = menuHtml;
            lucide.createIcons();
        }

        function renderOrder() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            if (!user) return renderLogin();

            return `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- User Info Panel -->
                <div class="canteen-card p-6 lg:col-span-1 h-fit">
                    <h3 class="text-2xl font-bold mb-4 flex items-center">
                        <i data-lucide="${user.isPriority ? 'crown' : 'user'}" class="w-6 h-6 mr-3 text-yellow-500"></i>
                        ${user.name}
                    </h3>
                    
                    <!-- NEW: Dynamic Token Lighting Button -->
                    <button class="token-button"> 
                        <div class="token-blob1"></div>
                        <div class="token-inner">
                            <p class="text-xs text-gray-300 uppercase tracking-widest">Your Token</p>
                            <p class="text-4xl font-extrabold" style="color:var(--primary-color);">${user.token}</p>
                            ${user.isPriority ? '<span class="text-xs text-blue-400">Priority User</span>' : ''}
                        </div>
                    </button>
                    <!-- END NEW TOKEN -->

                    <div class="bg-red-900/30 p-3 rounded-lg border border-red-700/50 mt-4">
                        <p class="text-sm font-semibold text-red-300">Outstanding Udhar (Dues):</p>
                        <p class="text-xl font-bold text-red-400">‚Çπ${APP_STATE.udharLedger[user.token] || 0}</p>
                    </div>
                </div>

                <!-- Menu and Cart -->
                <div class="lg:col-span-2">
                    <!-- Menu Section -->
                    <div class="canteen-card p-6 mb-8">
                        <h3 class="text-2xl font-bold mb-4 text-white border-b pb-2 border-gray-700">Cafeteria Menu (Real-Time Stock)</h3>
                        <div id="menu-list">
                            <!-- Menu content injected by renderMenuList() in setView -->
                        </div>
                    </div>

                    <!-- Cart Section -->
                    <div class="canteen-card p-6">
                        <h3 class="text-2xl font-bold mb-4 flex items-center">
                            <i data-lucide="shopping-cart" class="w-6 h-6 mr-3 text-white"></i>
                            Your Order Cart
                        </h3>
                        <div id="cart-items" class="min-h-[50px] text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
                            Cart is empty. Add items above.
                        </div>
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700">
                            <span class="text-xl font-bold">Total: <span id="cart-total" style="color:var(--primary-color);">‚Çπ0</span></span>
                            <button onclick="placeOrder()" class="glow-button px-6 py-2 rounded-lg disabled:opacity-30 disabled:shadow-none" id="place-order-btn" disabled>
                                Place Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderQueue() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            if (!user) return renderLogin();

            const myOrder = APP_STATE.orderQueue.find(o => o.token === user.token);

            const allOrders = APP_STATE.orderQueue.sort((a, b) => {
                // Priority users (F-tokens) always come first
                const aIsPrio = a.token.startsWith('F');
                const bIsPrio = b.token.startsWith('F');

                if (aIsPrio && !bIsPrio) return -1;
                if (!aIsPrio && bIsPrio) return 1;

                // Then sort by status (Ready > In Prep > Queued)
                const statusOrder = { 'Ready': 1, 'In Prep': 2, 'Queued': 3 };
                return statusOrder[a.status] - statusOrder[b.status];
            });

            const queueHtml = allOrders.map(order => {
                const isMine = order.token === user.token;
                const statusColor = { 'Ready': 'text-green-400', 'In Prep': 'text-yellow-400', 'Queued': 'text-gray-400' };

                return `
                    <div class="flex justify-between items-center p-4 mb-3 rounded-lg ${isMine ? 'bg-blue-600/20 border-l-4 border-blue-400' : 'bg-gray-700/30'}">
                        <div class="flex flex-col">
                            <span class="text-2xl font-bold" style="color:${isMine ? 'var(--primary-color)' : 'white'};">#${order.token}</span>
                            <span class="text-xs text-gray-400">${isMine ? 'Your Order' : '---'}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-semibold ${statusColor[order.status]}">${order.status}</span>
                            <p class="text-sm text-gray-400">Pickup: ${order.eta}</p>
                        </div>
                    </div>
                `;
            }).join('');

            return `
            <div class="max-w-xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-6">Real-Time Queue</h2>
                <div class="canteen-card p-6">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2 border-gray-700">Your Current Status</h3>
                    <div class="token-display p-4 rounded-lg mb-6 text-center ${!myOrder ? 'opacity-50' : ''}">
                        ${myOrder ? `
                            ${myOrder.status === 'Ready' ? `
                                <div class="ready-badge">üéâ YOUR TURN! üéâ</div>
                                <button onclick="confirmPickup()" class="glow-button mt-4 px-6 py-2 rounded-lg text-lg w-full">
                                    <i data-lucide="hand-metal" class="w-5 h-5 mr-2 inline-block"></i> CONFIRM PICKUP
                                </button>
                                <p class="text-sm text-gray-400 mt-4">Token is:</p>
                                <p class="text-4xl font-extrabold mb-1" style="color:var(--primary-color);">${myOrder.token}</p>
                            ` : `
                                <p class="text-sm text-gray-400">Your Token is currently:</p>
                                <p class="text-4xl font-extrabold mb-1" style="color:var(--primary-color);">${myOrder.token}</p>
                                <p class="text-2xl font-semibold ${myOrder.status === 'Ready' ? 'text-green-400' : 'text-yellow-400'}">${myOrder.status}</p>
                                <p class="text-sm text-gray-400">Estimated Pickup: ${myOrder.eta}</p>
                            `}

                        ` : '<p class="text-gray-400">No active order found. Place an order on the "Order Now" tab.</p>'}
                    </div>

                    <h3 class="text-xl font-bold mb-4 border-b pb-2 border-gray-700">Full Queue List</h3>
                    <div class="h-96 overflow-y-auto pr-2">
                        ${queueHtml}
                    </div>
                </div>
            </div>
            `;
        }

        function renderLeaderboard() {
            const sortedUsers = Object.values(APP_STATE.users)
                .filter(u => u.role !== 'Owner') // Filter out Owner from Leaderboard
                .sort((a, b) => b.ordersPlaced - a.ordersPlaced);

            const leaderboardHtml = sortedUsers.slice(0, 10).map((user, index) => {
                const rank = index + 1;
                let badgeIcon = '';
                if (rank === 1) badgeIcon = '<i data-lucide="award" class="w-5 h-5 text-yellow-400 mr-2 fill-yellow-400/50"></i>';
                else if (rank === 2) badgeIcon = '<i data-lucide="award" class="w-5 h-5 text-gray-300 mr-2 fill-gray-300/50"></i>';
                else if (rank === 3) badgeIcon = '<i data-lucide="award" class="w-5 h-5 text-orange-400 mr-2 fill-orange-400/50"></i>';
                else badgeIcon = '<i data-lucide="hash" class="w-5 h-5 text-gray-500 mr-2"></i>';

                return `
                    <div class="leader-item flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="w-6 text-lg font-bold mr-4 text-center ${rank <= 3 ? 'text-white' : 'text-gray-400'}">${rank}.</span>
                            ${badgeIcon}
                            <span class="font-semibold">${user.name}</span>
                        </div>
                        <span class="text-sm text-gray-300">${user.ordersPlaced} orders</span>
                    </div>
                `;
            }).join('');

            return `
            <div class="max-w-lg mx-auto">
                
                <!-- Integrated Leaderboard Glow Button -->
                <button class="leaderboard-btn-glow" onclick="setView('leaderboard')">
                    <span>üèÜ QUICKBITE LEADERBOARD üèÜ</span>
                </button>
                
                <div class="canteen-card p-6">
                    ${leaderboardHtml}
                    

                    <p class="text-center text-xs mt-4 text-gray-500">Udhar System & Stock Analytics are visible on the Canteen Dashboard only.</p>
                </div>
            </div>
            `;
        }
        
        function renderAccount() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            if (!user) return renderLogin();

            return `
            <div class="max-w-md mx-auto">
                <h2 class="text-3xl font-bold text-center mb-6">Account & Settings</h2>
                
                <div class="settings-menu mb-6">
                    <button class="settings-value">
                        <i data-lucide="user-check"></i>
                        <span>${user.name} (${user.id})</span>
                    </button>
                    <button class="settings-value">
                        <i data-lucide="fingerprint"></i>
                        <span>Permanent Token: <span style="color:var(--primary-color);">${user.token}</span></span>
                    </button>
                    <button class="settings-value">
                        <i data-lucide="utensils"></i>
                        <span>Total Orders: ${user.ordersPlaced}</span>
                    </button>
                </div>

                <div class="canteen-card p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2 border-gray-700">Financial Ledger (Udhar)</h3>
                    <div class="flex justify-between items-center bg-red-900/30 p-3 rounded-lg border border-red-700/50 mb-4">
                        <span class="text-red-300 font-semibold">Pending Dues:</span>
                        <span class="text-2xl font-bold text-red-400">‚Çπ${APP_STATE.udharLedger[user.token] || 0}</span>
                    </div>
                    <button class="login-btn w-full py-2 text-sm bg-green-600 hover:bg-green-500" onclick="clearUdhar()">
                        Clear Dues Now (Simulated Payment)
                    </button>
                </div>
                
                <button onclick="logout()" class="w-full py-2 text-sm text-red-400 hover:text-red-300 transition-colors mt-4">
                    Logout
                </button>
            </div>
            `;
        }
        
        // --- NEW OWNER DASHBOARD FUNCTION ---
        function updateStock(itemId, change) {
            const item = APP_STATE.menu.find(i => i.id === itemId);
            if (item) {
                item.stock = Math.max(0, item.stock + change);
                showMessage(`Stock for ${item.name} updated to ${item.stock}.`, 'info');
                setView('owner'); // Re-render the dashboard
            }
        }

        function updateOrderStatus(token, status) {
            const order = APP_STATE.orderQueue.find(o => o.token === token);
            if (order) {
                order.status = status;
                showMessage(`Order ${token} status updated to **${status}**.`, 'success');
                setView('owner');
            }
        }
        
        function clearUdharOwner(token) {
             const amount = APP_STATE.udharLedger[token] || 0;
            if (amount > 0) {
                APP_STATE.udharLedger[token] = 0;
                showMessage(`Dues of ‚Çπ${amount} for Token ${token} cleared.`, 'success');
                setView('owner');
            } else {
                showMessage(`Token ${token} has no outstanding dues.`, 'info');
            }
        }
        
        function renderOwnerDashboard() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            if (user?.role !== 'Owner') return renderLogin();

            // --- 1. Live Orders ---
            const liveOrdersHtml = APP_STATE.orderQueue.map(order => `
                <div class="bg-gray-700/50 p-4 rounded-lg mb-3 flex justify-between items-center border-l-4 border-yellow-400">
                    <div>
                        <p class="text-xl font-bold text-white">Token: ${order.token}</p>
                        <p class="text-sm text-gray-300">Items: ${order.items}</p>
                        <p class="text-sm text-gray-300">Status: <span class="font-semibold text-yellow-300">${order.status}</span></p>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button onclick="updateOrderStatus('${order.token}', 'Ready')" 
                                class="bg-green-600 text-white px-3 py-1 rounded-full text-xs hover:bg-green-500 disabled:opacity-50"
                                ${order.status === 'Ready' || order.status === 'Complete' ? 'disabled' : ''}>
                            Ready
                        </button>
                        <button onclick="updateOrderStatus('${order.token}', 'Complete')" 
                                class="bg-red-600 text-white px-3 py-1 rounded-full text-xs hover:bg-red-500 disabled:opacity-50"
                                ${order.status === 'Complete' ? 'disabled' : ''}>
                            Complete
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-400 p-4">No active orders in the queue.</p>';

            // --- 2. Udhar Ledger ---
            const udharHtml = Object.keys(APP_STATE.udharLedger).map(token => {
                const amount = APP_STATE.udharLedger[token];
                const userData = Object.values(APP_STATE.users).find(u => u.token === token);
                const name = userData ? userData.name : 'Unknown User';

                return `
                    <div class="flex justify-between items-center p-3 mb-2 rounded-lg bg-red-900/20">
                        <div>
                            <p class="text-white">${name} (#${token})</p>
                            <p class="text-lg font-bold text-red-400">‚Çπ${amount}</p>
                        </div>
                        <button onclick="clearUdharOwner('${token}')" 
                                class="bg-gray-600 text-white px-3 py-1 rounded-md text-xs hover:bg-gray-500 disabled:opacity-30"
                                ${amount === 0 ? 'disabled' : ''}>
                            Clear Dues
                        </button>
                    </div>
                `;
            }).join('');

            // --- 3. Stock Management ---
            const stockHtml = APP_STATE.menu.map(item => `
                <div class="flex justify-between items-center p-3 mb-2 border-b border-gray-600">
                    <span class="text-white">${item.name} (‚Çπ${item.price})</span>
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-bold text-green-400 w-8 text-right">${item.stock}</span>
                        <button onclick="updateStock('${item.id}', -1)" class="bg-red-600 text-white p-2 rounded text-xs hover:bg-red-500">
                            <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <button onclick="updateStock('${item.id}', 10)" class="bg-blue-600 text-white p-2 rounded text-xs hover:bg-blue-500">
                            <i data-lucide="plus" class="w-4 h-4"></i>10
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6 flex items-center justify-center">
                        <i data-lucide="shield" class="w-8 h-8 mr-3 text-red-400"></i>
                        Owner Dashboard
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Live Orders Column -->
                        <div class="canteen-card p-6">
                            <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-red-700 text-red-300 flex items-center">
                                <i data-lucide="bell" class="w-5 h-5 mr-2"></i> Live Orders & Processing
                            </h3>
                            <div class="h-96 overflow-y-auto pr-2" id="live-orders-list">
                                ${liveOrdersHtml}
                            </div>
                        </div>

                        <!-- Ledger & Stock Column -->
                        <div class="space-y-6">
                            
                            <!-- Stock Management -->
                            <div class="canteen-card p-6">
                                <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-yellow-700 text-yellow-300 flex items-center">
                                    <i data-lucide="box" class="w-5 h-5 mr-2"></i> Stock Availability
                                </h3>
                                <div class="h-48 overflow-y-auto pr-2" id="stock-management-list">
                                    ${stockHtml}
                                </div>
                            </div>
                            
                            <!-- Digital Ledger -->
                            <div class="canteen-card p-6">
                                <h3 class="text-2xl font-bold mb-4 border-b pb-2 border-blue-700 text-blue-300 flex items-center">
                                    <i data-lucide="book-open-text" class="w-5 h-5 mr-2"></i> Digital Dues Ledger (Udhar)
                                </h3>
                                <div class="h-48 overflow-y-auto pr-2" id="udhar-ledger-list">
                                    ${udharHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="logout()" class="login-btn mt-6 w-full py-3 bg-gray-600 hover:bg-gray-500">
                        Logout from Owner Dashboard
                    </button>
                </div>
            `;
        }
        // --- END OWNER DASHBOARD FUNCTION ---
        
        
        // --- CORE LOGIC ---

        let cart = [];

        function addToCart(itemId) {
            const item = APP_STATE.menu.find(i => i.id === itemId);
            if (item && item.stock > 0) {
                const cartItem = cart.find(c => c.id === itemId);
                if (cartItem) {
                    cartItem.quantity++;
                } else {
                    cart.push({ ...item, quantity: 1 });
                }
                updateCartUI();
                showMessage(`${item.name} added to cart!`, 'info');
            } else {
                showMessage(`Sorry, ${item.name} is out of stock.`, 'error');
            }
        }

        function removeFromCart(itemId) {
            const cartItemIndex = cart.findIndex(c => c.id === itemId);
            if (cartItemIndex !== -1) {
                const cartItem = cart[cartItemIndex];
                cartItem.quantity--;
                if (cartItem.quantity <= 0) {
                    cart.splice(cartItemIndex, 1);
                }
            }
            updateCartUI();
        }

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalSpan = document.getElementById('cart-total');
            const placeOrderBtn = document.getElementById('place-order-btn');
            
            let total = 0;
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = 'Cart is empty. Add items above.';
                cartTotalSpan.textContent = '‚Çπ0';
                placeOrderBtn.disabled = true;
                return;
            }

            const cartHtml = cart.map(item => {
                total += item.price * item.quantity;
                return `
                    <div class="flex justify-between items-center bg-gray-700/50 p-3 rounded-lg mb-2">
                        <span class="text-white">${item.name} x ${item.quantity}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-300">‚Çπ${item.price * item.quantity}</span>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-400 hover:text-red-500">
                                <i data-lucide="minus-circle" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            cartItemsContainer.innerHTML = cartHtml;
            cartTotalSpan.textContent = `‚Çπ${total}`;
            placeOrderBtn.disabled = false;
            lucide.createIcons(); // Re-render lucide icons
        }
        
        function placeOrder() {
            if (cart.length === 0) return;

            const user = APP_STATE.users[APP_STATE.currentUserId];
            const orderItems = cart.map(item => `${item.name} x${item.quantity}`).join(', ');
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // 1. Stock Decrease (Simulated)
            cart.forEach(cartItem => {
                const menuItem = APP_STATE.menu.find(m => m.id === cartItem.id);
                if (menuItem) menuItem.stock -= cartItem.quantity;
            });

            // 2. Queueing Logic (Dynamic Time Slot Simulation)
            const baseWaitTime = user.isPriority ? 5 : 10;
            const prepTime = cart.length * 2; // 2 minutes per item
            const totalWait = baseWaitTime + prepTime;
            const etaDate = new Date();
            etaDate.setMinutes(etaDate.getMinutes() + totalWait);
            const etaString = etaDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            // 3. Udhar Option (Simulated: Auto-credit if large order)
            let finalAmount = totalAmount;
            let paymentNote = "Paid in cash/digital.";

            if (finalAmount > 100 && Math.random() < 0.3) { // 30% chance for Udhar if order is > 100
                APP_STATE.udharLedger[user.token] = (APP_STATE.udharLedger[user.token] || 0) + finalAmount;
                paymentNote = `Payment recorded as **Udhar** (‚Çπ${finalAmount} pending). Please settle your dues later.`;
            }

            // 4. Update Queue
            APP_STATE.orderQueue.push({
                token: user.token,
                items: orderItems,
                status: 'Queued',
                eta: etaString
            });

            // 5. Update User Stats
            user.ordersPlaced++;

            // 6. Clear Cart & Show Success
            cart = [];
            
            showMessage(`Order Placed! Token: **${user.token}**. Pickup time: **${etaString}** (${paymentNote})`, 'success');
            setView('queue'); // Switch to queue view to see the new order
        }

        // --- NEW FEATURE: CONFIRM PICKUP ---
        function confirmPickup() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            // Find the order that is ready for the current user
            const index = APP_STATE.orderQueue.findIndex(o => o.token === user.token && o.status === 'Ready');

            if (index !== -1) {
                // Remove the order from the queue, simulating successful pickup
                APP_STATE.orderQueue.splice(index, 1);
                showMessage('Order picked up! Enjoy your QuickBite!', 'success');
                // The Owner dashboard should ideally update the status to 'Complete' 
                // but since the user has picked it up, we remove it from the display.
                setView('queue'); // Re-render queue which will now show "No active order"
            } else {
                showMessage('The order is not yet ready for pickup.', 'error');
            }
        }
        // --- END CONFIRM PICKUP ---


        function clearUdhar() {
            const user = APP_STATE.users[APP_STATE.currentUserId];
            const amount = APP_STATE.udharLedger[user.token] || 0;
            if (amount > 0) {
                APP_STATE.udharLedger[user.token] = 0;
                showMessage(`Dues of ‚Çπ${amount} cleared successfully!`, 'success');
                setView('account');
            } else {
                showMessage('You have no outstanding dues!', 'info');
            }
        }

        function logout() {
            APP_STATE.currentUserId = null;
            showMessage('You have been logged out.', 'info');
            setView('login');
        }


        // --- UTILITY & VIEW SWITCHING ---
        
        let currentView = 'login'; 

        function setView(viewName) {
            currentView = viewName;
            const viewContainer = document.getElementById('view-container');
            const navbar = document.getElementById('navbar');
            let htmlContent = '';

            // Handle Owner View (hides customer navbar)
            if (viewName === 'owner') {
                navbar.classList.add('hidden');
                htmlContent = renderOwnerDashboard();
            } else {
                navbar.classList.remove('hidden');

                // Ensure customer is logged in for customer views
                if (viewName !== 'login' && !APP_STATE.currentUserId) {
                    viewName = 'login';
                }

                switch(viewName) {
                    case 'order':
                        htmlContent = renderOrder();
                        break;
                    case 'queue':
                        htmlContent = renderQueue();
                        break;
                    case 'leaderboard':
                        htmlContent = renderLeaderboard();
                        break;
                    case 'account':
                        htmlContent = renderAccount();
                        break;
                    case 'login':
                    default:
                        htmlContent = renderLogin();
                        break;
                }
            }


            viewContainer.innerHTML = htmlContent;
            lucide.createIcons(); // Initialize Lucide icons on the new content
            
            // Re-check and update cart/menu UI if order view is loaded
            if (viewName === 'order') {
                updateCartUI();
                renderMenuList(); // Call the menu list rendering function
            }
        }

        // Custom Message Box (No Alerts!)
        function showMessage(message, type) {
            const existingMessage = document.getElementById('app-message');
            if (existingMessage) existingMessage.remove();

            const bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
            const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'x-circle' : 'info');

            const msgHtml = document.createElement('div');
            msgHtml.id = 'app-message';
            msgHtml.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-xl text-white z-[100] transition-all duration-300 flex items-center ${bgColor}`;
            msgHtml.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-3"></i> ${message}`;
            
            document.body.appendChild(msgHtml);
            lucide.createIcons();

            setTimeout(() => {
                msgHtml.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => msgHtml.remove(), 300);
            }, 5000);
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            // Force login view at start
            APP_STATE.currentUserId = null;
            setView('login');
        };

    </script>
</body>
</html>
